<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PDF Studio V2.1</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Outfit:wght@300;400;500;600&display=swap');

:root {
  --bg:#f0f4ff; --white:#fff; --border:#e2e8f8;
  --blue:#4361ee; --purple:#7b5ea7; --green:#2ec4b6;
  --orange:#ff9f1c; --red:#e63946; --text:#1a1d2e; --text2:#6b7194;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);font-family:'Outfit',sans-serif;color:var(--text);min-height:100vh;display:flex;flex-direction:column;}

/* HEADER */
header{background:var(--white);border-bottom:1px solid var(--border);padding:0 32px;display:flex;align-items:center;justify-content:space-between;height:64px;position:sticky;top:0;z-index:200;box-shadow:0 2px 10px rgba(67,97,238,.07);flex-shrink:0;}
.logo{font-family:'Nunito',sans-serif;font-weight:900;font-size:1.35rem;display:flex;align-items:center;gap:10px;}
.logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--blue),var(--purple));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;}
.logo-text{background:linear-gradient(135deg,var(--blue),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.nav{display:flex;gap:4px;background:var(--bg);padding:4px;border-radius:12px;border:1px solid var(--border);}
.nav-tab{padding:7px 18px;border:none;background:transparent;border-radius:9px;font-family:'Outfit',sans-serif;font-size:.88rem;font-weight:600;color:var(--text2);cursor:pointer;transition:all .2s;}
.nav-tab.active{background:var(--white);color:var(--blue);box-shadow:0 2px 8px rgba(67,97,238,.12);}

/* MAIN */
.main{flex:1;}
.page{display:none;padding:28px 32px;max-width:1080px;margin:0 auto;width:100%;}
.page.active{display:block;}
#page-editor{padding:0;max-width:none;}

.page-title{font-family:'Nunito',sans-serif;font-weight:800;font-size:1.5rem;margin-bottom:4px;}
.page-sub{color:var(--text2);font-size:.9rem;margin-bottom:24px;}

/* DROPZONE */
.dropzone{border:3px dashed var(--border);border-radius:20px;padding:44px 28px;text-align:center;background:var(--white);margin-bottom:20px;transition:border-color .2s,background .2s;cursor:pointer;user-select:none;}
.dropzone:hover{border-color:#a0b0f0;}
.dropzone.over{border-color:var(--blue);background:#f0f3ff;}
.dz-icon{font-size:3rem;display:block;margin-bottom:12px;}
.dz-title{font-family:'Nunito',sans-serif;font-weight:800;font-size:1.15rem;margin-bottom:6px;}
.dz-sub{color:var(--text2);font-size:.85rem;margin-bottom:18px;}
.fmt-pills{display:flex;flex-wrap:wrap;gap:5px;justify-content:center;margin-bottom:18px;}
.pill{padding:3px 10px;border-radius:20px;font-size:.72rem;font-weight:700;}
.p-img{background:#dbeafe;color:#1d4ed8;}.p-doc{background:#ede9fe;color:#6d28d9;}.p-pdf{background:#fee2e2;color:#b91c1c;}.p-txt{background:#d1fae5;color:#065f46;}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:7px;padding:10px 22px;border:none;border-radius:10px;font-family:'Outfit',sans-serif;font-weight:600;font-size:.88rem;cursor:pointer;transition:all .18s;}
.btn-blue{background:var(--blue);color:#fff;} .btn-blue:hover{background:#3451d1;transform:translateY(-1px);}
.btn-green{background:var(--green);color:#fff;} .btn-green:hover{background:#27a89e;transform:translateY(-1px);}
.btn-ghost{background:var(--white);color:var(--text2);border:1.5px solid var(--border);} .btn-ghost:hover{border-color:var(--blue);color:var(--blue);}
.btn-sm{padding:6px 14px;font-size:.8rem;border-radius:8px;}

/* OPTIONS */
.options-row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:18px;}
.opt-card{background:var(--white);border:1.5px solid var(--border);border-radius:12px;padding:12px 16px;flex:1;min-width:130px;}
.opt-label{font-size:.72rem;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:7px;}
select,input[type="number"]{background:var(--bg);border:1.5px solid var(--border);color:var(--text);padding:6px 10px;border-radius:8px;font-family:'Outfit',sans-serif;font-size:.83rem;width:100%;cursor:pointer;}
select:focus,input:focus{outline:none;border-color:var(--blue);}
.toggle-row{display:flex;align-items:center;gap:9px;padding-top:2px;}
.toggle{position:relative;width:40px;height:22px;background:#cbd5e1;border-radius:11px;cursor:pointer;border:none;transition:background .2s;flex-shrink:0;}
.toggle.on{background:var(--blue);}
.toggle::after{content:'';position:absolute;width:16px;height:16px;background:white;border-radius:50%;top:3px;left:3px;transition:left .2s;box-shadow:0 1px 3px rgba(0,0,0,.2);}
.toggle.on::after{left:21px;}
.toggle-lbl{font-size:.83rem;font-weight:600;}

/* FILE LIST */
.files-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.files-hdr-left{display:flex;align-items:center;gap:8px;font-family:'Nunito',sans-serif;font-weight:800;font-size:.95rem;}
.cnt-badge{background:var(--blue);color:white;border-radius:20px;padding:1px 9px;font-size:.75rem;font-weight:700;}
.drag-hint{font-size:.77rem;color:var(--text2);}
#fileCards{display:flex;flex-direction:column;gap:8px;min-height:10px;margin-bottom:20px;}
.empty-state{text-align:center;padding:28px;color:var(--text2);font-size:.88rem;border:2px dashed var(--border);border-radius:14px;background:rgba(255,255,255,.6);}
.empty-icon{font-size:2rem;display:block;margin-bottom:8px;}

/* FILE CARD */
.file-card{background:var(--white);border:2px solid var(--border);border-radius:14px;padding:12px 14px;display:flex;align-items:center;gap:12px;transition:border-color .15s,box-shadow .15s,transform .15s;}
.file-card:hover{border-color:#a0b0f0;box-shadow:0 2px 12px rgba(67,97,238,.09);}
.file-card.dragging{opacity:.4;transform:scale(.98);border-style:dashed;}
.file-card.drag-over{border-color:var(--blue);background:#f0f3ff;transform:scale(1.01);}
.drag-handle{color:#c0cadf;font-size:1.1rem;cursor:grab;flex-shrink:0;padding:2px 4px;line-height:1;}
.drag-handle:active{cursor:grabbing;}
.fc-num{width:26px;height:26px;background:linear-gradient(135deg,var(--blue),var(--purple));color:white;border-radius:7px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.78rem;flex-shrink:0;font-family:'Nunito',sans-serif;}
.fc-thumb{width:40px;height:48px;border-radius:7px;overflow:hidden;flex-shrink:0;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;background:var(--bg);font-size:1.4rem;}
.fc-thumb img{width:100%;height:100%;object-fit:cover;}
.fc-info{flex:1;min-width:0;}
.fc-name{font-weight:700;font-size:.87rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px;}
.fc-meta{font-size:.75rem;color:var(--text2);display:flex;gap:8px;}
.fc-status{padding:3px 9px;border-radius:20px;font-size:.73rem;font-weight:700;flex-shrink:0;}
.s-ready{background:#dbeafe;color:#1d4ed8;} .s-working{background:#fef3c7;color:#92400e;} .s-done{background:#d1fae5;color:#065f46;} .s-error{background:#fee2e2;color:#b91c1c;}
.fc-del{background:none;border:none;color:#c0cadf;cursor:pointer;font-size:1rem;padding:3px 6px;border-radius:6px;transition:all .15s;flex-shrink:0;}
.fc-del:hover{background:#fee2e2;color:var(--red);}

/* PROGRESS */
.prog-wrap{background:var(--white);border:1px solid var(--border);border-radius:14px;padding:18px 20px;display:none;margin-bottom:14px;}
.prog-wrap.show{display:block;}
.prog-label{font-weight:700;font-size:.87rem;margin-bottom:10px;}
.prog-bar{height:8px;background:var(--bg);border-radius:4px;overflow:hidden;}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--blue),var(--purple));border-radius:4px;transition:width .3s;width:0%;}
.prog-step{font-size:.77rem;color:var(--text2);margin-top:6px;}

/* ACTIONS BAR */
.actions-bar{background:var(--white);border:1px solid var(--border);border-radius:16px;padding:16px 20px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;box-shadow:0 2px 12px rgba(67,97,238,.06);}
.actions-bar .spacer{flex:1;}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(5px);display:none;align-items:center;justify-content:center;z-index:9999;}
.overlay.show{display:flex;}
.modal{background:var(--white);border-radius:20px;padding:36px;text-align:center;max-width:380px;width:90%;box-shadow:0 16px 48px rgba(0,0,0,.13);animation:popIn .3s cubic-bezier(.175,.885,.32,1.275);}
@keyframes popIn{from{opacity:0;transform:scale(.85)}to{opacity:1;transform:scale(1)}}
.modal-icon{font-size:3.5rem;display:block;margin-bottom:14px;}
.modal-title{font-family:'Nunito',sans-serif;font-weight:900;font-size:1.4rem;margin-bottom:6px;}
.modal-sub{color:var(--text2);font-size:.87rem;margin-bottom:22px;line-height:1.6;}
.modal-btns{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}

/* TOAST */
.toast{position:fixed;bottom:72px;right:24px;background:var(--text);color:white;border-radius:12px;padding:12px 18px;font-size:.86rem;font-weight:600;z-index:99999;animation:toastIn .25s ease;box-shadow:0 6px 24px rgba(0,0,0,.12);pointer-events:none;}
.toast.ok{background:var(--green);} .toast.err{background:var(--red);}
@keyframes toastIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

/* FOOTER */
footer{text-align:center;padding:13px 24px;font-size:.78rem;color:var(--text2);border-top:1px solid var(--border);background:var(--white);flex-shrink:0;}

/* ‚ïê‚ïê EDITOR ‚ïê‚ïê */
.ed-layout{display:grid;grid-template-columns:210px 1fr 196px;height:calc(100vh - 64px - 45px);}
.ed-side{background:var(--white);border-right:1px solid var(--border);overflow-y:auto;display:flex;flex-direction:column;}
.ed-side::-webkit-scrollbar{width:3px;} .ed-side::-webkit-scrollbar-thumb{background:var(--border);}
.ed-sec{padding:12px;border-bottom:1px solid var(--border);}
.ed-lbl{font-size:.68rem;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--text2);margin-bottom:9px;}
.tools-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px;}
.t-btn{padding:8px 4px;background:var(--bg);border:1.5px solid var(--border);border-radius:9px;color:var(--text2);font-family:'Outfit',sans-serif;font-size:.75rem;font-weight:600;cursor:pointer;transition:all .15s;text-align:center;display:flex;flex-direction:column;align-items:center;gap:2px;}
.t-btn .ti{font-size:1.05rem;}
.t-btn:hover,.t-btn.active{background:#eef1ff;border-color:var(--blue);color:var(--blue);}
.sym-grid{display:flex;flex-wrap:wrap;gap:4px;}
.sym-btn{width:32px;height:32px;background:var(--bg);border:1.5px solid var(--border);border-radius:7px;cursor:pointer;font-size:.95rem;display:flex;align-items:center;justify-content:center;transition:all .12s;}
.sym-btn:hover{background:#eef1ff;border-color:var(--blue);}
.sw-row{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:7px;}
.sw{width:20px;height:20px;border-radius:5px;cursor:pointer;border:2px solid transparent;transition:all .12s;}
.sw.sel{border-color:var(--text);transform:scale(1.2);}
.sw-tr{background:repeating-conic-gradient(#ccc 0% 25%,#fff 0% 50%) 0 0/10px 10px;}
input[type="color"]{width:30px;height:30px;border:1.5px solid var(--border);border-radius:7px;padding:2px;background:none;cursor:pointer;}
.pr2{display:flex;align-items:center;gap:7px;margin-bottom:6px;}
.pr2-lbl{font-size:.75rem;color:var(--text2);flex-shrink:0;width:52px;}
input[type="range"]{flex:1;accent-color:var(--blue);height:3px;cursor:pointer;}
.pr2-val{font-size:.75rem;min-width:26px;text-align:right;font-weight:600;}
.font-sel{background:var(--bg);border:1.5px solid var(--border);color:var(--text);padding:5px 8px;border-radius:8px;font-family:'Outfit',sans-serif;font-size:.8rem;width:100%;margin-bottom:6px;}
.style-row{display:flex;gap:3px;margin-bottom:6px;}
.sty-btn{flex:1;padding:5px;background:var(--bg);border:1.5px solid var(--border);border-radius:7px;cursor:pointer;font-size:.83rem;text-align:center;transition:all .12s;font-family:serif;}
.sty-btn:hover,.sty-btn.on{background:#eef1ff;border-color:var(--blue);color:var(--blue);}
.pg-presets{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:8px;}
.pg-btn{padding:6px;background:var(--bg);border:1.5px solid var(--border);border-radius:7px;font-size:.75rem;font-weight:700;color:var(--text2);cursor:pointer;text-align:center;transition:all .12s;}
.pg-btn:hover,.pg-btn.active{border-color:var(--blue);color:var(--blue);background:#eef1ff;}
.import-drop{border:2px dashed var(--border);border-radius:10px;padding:12px;text-align:center;cursor:pointer;font-size:.77rem;color:var(--text2);font-weight:600;transition:all .15s;}
.import-drop:hover{border-color:var(--blue);color:var(--blue);background:#eef1ff;}
.ed-center{display:flex;flex-direction:column;background:#dde3f5;overflow:hidden;}
.ed-toolbar{background:var(--white);border-bottom:1px solid var(--border);padding:7px 12px;display:flex;align-items:center;gap:5px;flex-wrap:wrap;flex-shrink:0;}
.tb{padding:5px 10px;border:1.5px solid var(--border);background:var(--bg);border-radius:7px;font-family:'Outfit',sans-serif;font-size:.78rem;font-weight:600;color:var(--text2);cursor:pointer;transition:all .12s;display:flex;align-items:center;gap:4px;}
.tb:hover{border-color:var(--blue);color:var(--blue);background:#eef1ff;}
.tb.tb-exp{background:var(--blue);color:white;border-color:var(--blue);} .tb.tb-exp:hover{background:#3451d1;}
.tb-sep{width:1px;height:20px;background:var(--border);margin:0 2px;}
.canvas-wrap{flex:1;overflow:auto;display:flex;align-items:flex-start;justify-content:center;padding:24px;}
.canvas-wrap::-webkit-scrollbar{width:7px;height:7px;} .canvas-wrap::-webkit-scrollbar-thumb{background:#b0bcdc;border-radius:4px;}
.ed-props{background:var(--white);border-left:1px solid var(--border);overflow-y:auto;padding:12px;}
.ed-props::-webkit-scrollbar{width:3px;} .ed-props::-webkit-scrollbar-thumb{background:var(--border);}
.no-sel{text-align:center;padding:20px 8px;color:var(--text2);font-size:.8rem;line-height:1.6;}
.no-sel-icon{font-size:1.8rem;display:block;margin-bottom:7px;}
.prop-in{background:var(--bg);border:1.5px solid var(--border);color:var(--text);padding:5px 8px;border-radius:7px;font-family:'Outfit',sans-serif;font-size:.8rem;width:62px;}
.pa{width:100%;padding:7px;background:var(--bg);border:1.5px solid var(--border);border-radius:8px;font-family:'Outfit',sans-serif;font-size:.78rem;font-weight:600;color:var(--text2);cursor:pointer;transition:all .12s;margin-bottom:4px;text-align:center;}
.pa:hover{border-color:var(--blue);color:var(--blue);background:#eef1ff;}
.pa-del{border-color:#fecaca;color:var(--red);background:#fee2e2;} .pa-del:hover{background:#fecaca;}
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">üìÑ</div>
    <span class="logo-text">PDF Studio</span>
  </div>
  <nav class="nav">
    <button class="nav-tab active" id="tab-convert" onclick="goPage('convert')">üìÇ Convertir &amp; Fusionner</button>
    <button class="nav-tab" id="tab-editor" onclick="goPage('editor')">‚úèÔ∏è √âditeur</button>
  </nav>
  <div style="width:160px;text-align:right;font-size:.78rem;color:var(--text2);font-weight:600;">V2.1</div>
</header>

<div class="main">

<!-- ‚ïê‚ïê‚ïê PAGE CONVERT ‚ïê‚ïê‚ïê -->
<div class="page active" id="page-convert">

  <div class="page-title">üìÇ Vos fichiers ‚Üí PDF</div>
  <p class="page-sub">D√©posez vos fichiers, r√©organisez-les par glisser-d√©poser, puis convertissez ou fusionnez en un seul PDF.</p>

  <div class="dropzone" id="dropzone">
    <span class="dz-icon">üì•</span>
    <div class="dz-title">Glissez vos fichiers ici</div>
    <div class="dz-sub">ou cliquez pour parcourir votre ordinateur</div>
    <div class="fmt-pills">
      <span class="pill p-img">JPG</span><span class="pill p-img">PNG</span>
      <span class="pill p-img">WebP</span><span class="pill p-img">HEIC</span>
      <span class="pill p-img">GIF</span><span class="pill p-doc">DOCX</span>
      <span class="pill p-pdf">PDF</span><span class="pill p-txt">TXT</span>
      <span class="pill p-txt">HTML</span>
    </div>
    <button class="btn btn-blue" id="btnChoose" type="button">Ôºã Choisir des fichiers</button>
  </div>

  <!-- input OUTSIDE dropzone -->
  <input type="file" id="fileInput" multiple accept="image/*,.pdf,.doc,.docx,.txt,.html,.htm" style="display:none">

  <div class="options-row">
    <div class="opt-card">
      <div class="opt-label">üìÑ Format</div>
      <select id="optFmt">
        <option value="a4">A4 (210√ó297 mm)</option>
        <option value="a3">A3 (297√ó420 mm)</option>
        <option value="letter">Letter (US)</option>
        <option value="legal">Legal (US)</option>
      </select>
    </div>
    <div class="opt-card">
      <div class="opt-label">‚ÜîÔ∏è Orientation</div>
      <select id="optOri">
        <option value="portrait">Portrait</option>
        <option value="landscape">Paysage</option>
      </select>
    </div>
    <div class="opt-card">
      <div class="opt-label">üî≤ Marges (mm)</div>
      <input type="number" id="optMargin" value="10" min="0" max="50">
    </div>
    <div class="opt-card">
      <div class="opt-label">üîó Fusionner</div>
      <div class="toggle-row">
        <button class="toggle on" id="mergeToggle" type="button"></button>
        <span class="toggle-lbl" id="mergeLbl">Activ√©</span>
      </div>
    </div>
  </div>

  <div class="files-hdr">
    <div class="files-hdr-left">Fichiers <span class="cnt-badge" id="cntBadge">0</span></div>
    <div style="display:flex;align-items:center;gap:10px;">
      <span class="drag-hint">‚†ø Glissez les cartes pour r√©ordonner</span>
      <button class="btn btn-ghost btn-sm" type="button" onclick="clearAll()">Tout effacer</button>
    </div>
  </div>

  <div id="fileCards">
    <div class="empty-state"><span class="empty-icon">üìã</span>Aucun fichier.<br>Utilisez la zone ci-dessus pour en ajouter.</div>
  </div>

  <div class="prog-wrap" id="progWrap">
    <div class="prog-label">‚öôÔ∏è <span id="progLbl">En cours‚Ä¶</span></div>
    <div class="prog-bar"><div class="prog-fill" id="progFill"></div></div>
    <div class="prog-step" id="progStep"></div>
  </div>

  <div class="actions-bar">
    <button class="btn btn-blue" type="button" onclick="runConvert()">üîÑ Convertir en PDF</button>
    <button class="btn btn-green" type="button" id="btnDl" style="display:none" onclick="downloadAll()">‚¨áÔ∏è T√©l√©charger</button>
    <div class="spacer"></div>
    <button class="btn btn-ghost btn-sm" type="button" id="btnAddMore">Ôºã Ajouter des fichiers</button>
  </div>

</div><!-- /page-convert -->


<!-- ‚ïê‚ïê‚ïê PAGE EDITOR ‚ïê‚ïê‚ïê -->
<div class="page" id="page-editor">
<div class="ed-layout">

  <!-- LEFT -->
  <div class="ed-side">
    <div class="ed-sec">
      <div class="ed-lbl">Outils</div>
      <div class="tools-grid">
        <button class="t-btn active" id="tb-select" type="button" onclick="setTool('select')"><span class="ti">üñ±Ô∏è</span>S√©lection</button>
        <button class="t-btn" id="tb-text"   type="button" onclick="setTool('text')"><span class="ti" style="font-weight:900;font-size:1.1rem">T</span>Texte</button>
        <button class="t-btn" id="tb-rect"   type="button" onclick="setTool('rect')"><span class="ti">‚ñ≠</span>Rectangle</button>
        <button class="t-btn" id="tb-circle" type="button" onclick="setTool('circle')"><span class="ti">‚óã</span>Cercle</button>
        <button class="t-btn" id="tb-line"   type="button" onclick="setTool('line')"><span class="ti">‚ï±</span>Ligne</button>
        <button class="t-btn" id="tb-arrow"  type="button" onclick="addArrow()"><span class="ti">‚ûú</span>Fl√®che</button>
        <button class="t-btn" id="tb-draw"   type="button" onclick="setTool('draw')"><span class="ti">‚úèÔ∏è</span>Dessin libre</button>
        <button class="t-btn" id="tb-erase"  type="button" onclick="setTool('erase')"><span class="ti">üßπ</span>Gomme</button>
      </div>
    </div>
    <div class="ed-sec">
      <div class="ed-lbl">Symboles</div>
      <div class="sym-grid">
        <button class="sym-btn" type="button" onclick="addSym('‚úì')">‚úì</button>
        <button class="sym-btn" type="button" onclick="addSym('‚úó')">‚úó</button>
        <button class="sym-btn" type="button" onclick="addSym('‚òÖ')">‚òÖ</button>
        <button class="sym-btn" type="button" onclick="addSym('!')">!</button>
        <button class="sym-btn" type="button" onclick="addSym('?')">?</button>
        <button class="sym-btn" type="button" onclick="addSym('‚ûú')">‚ûú</button>
        <button class="sym-btn" type="button" onclick="addSym('‚¨Ü')">‚¨Ü</button>
        <button class="sym-btn" type="button" onclick="addSym('‚¨á')">‚¨á</button>
        <button class="sym-btn" type="button" onclick="addSym('¬©')">¬©</button>
        <button class="sym-btn" type="button" onclick="addSym('¬Æ')">¬Æ</button>
        <button class="sym-btn" type="button" onclick="addSym('‚Ñ¢')">‚Ñ¢</button>
        <button class="sym-btn" type="button" onclick="addSym('üìå')">üìå</button>
      </div>
    </div>
    <div class="ed-sec">
      <div class="ed-lbl">Couleur remplissage</div>
      <div class="sw-row" id="fillSw">
        <div class="sw sel" style="background:#4361ee" data-c="#4361ee" onclick="pickFill(this)"></div>
        <div class="sw" style="background:#e63946" data-c="#e63946" onclick="pickFill(this)"></div>
        <div class="sw" style="background:#2ec4b6" data-c="#2ec4b6" onclick="pickFill(this)"></div>
        <div class="sw" style="background:#ff9f1c" data-c="#ff9f1c" onclick="pickFill(this)"></div>
        <div class="sw" style="background:#7b5ea7" data-c="#7b5ea7" onclick="pickFill(this)"></div>
        <div class="sw" style="background:#000" data-c="#000000" onclick="pickFill(this)"></div>
        <div class="sw" style="background:#fff;border:1.5px solid #ddd" data-c="#ffffff" onclick="pickFill(this)"></div>
        <div class="sw sw-tr" data-c="transparent" onclick="pickFill(this)" title="Transparent"></div>
      </div>
      <div style="display:flex;gap:7px;align-items:center">
        <input type="color" id="fillPicker" value="#4361ee" oninput="setFillC(this.value)">
        <span style="font-size:.75rem;color:var(--text2)">Personnalis√©e</span>
      </div>
    </div>
    <div class="ed-sec">
      <div class="ed-lbl">Couleur contour</div>
      <div class="sw-row" id="strokeSw">
        <div class="sw sel" style="background:#1a1d2e" data-c="#1a1d2e" onclick="pickStroke(this)"></div>
        <div class="sw" style="background:#4361ee" data-c="#4361ee" onclick="pickStroke(this)"></div>
        <div class="sw" style="background:#e63946" data-c="#e63946" onclick="pickStroke(this)"></div>
        <div class="sw" style="background:#fff;border:1.5px solid #ddd" data-c="#ffffff" onclick="pickStroke(this)"></div>
        <div class="sw sw-tr" data-c="transparent" onclick="pickStroke(this)" title="Aucun"></div>
      </div>
      <div style="display:flex;gap:7px;align-items:center">
        <input type="color" id="strokePicker" value="#1a1d2e" oninput="setStrokeC(this.value)">
        <span style="font-size:.75rem;color:var(--text2)">Personnalis√©e</span>
      </div>
    </div>
    <div class="ed-sec">
      <div class="ed-lbl">√âpaisseur &amp; Opacit√©</div>
      <div class="pr2"><span class="pr2-lbl">Contour</span><input type="range" id="swRange" min="0" max="20" value="2" oninput="updateSW(this.value)"><span class="pr2-val" id="swVal">2</span></div>
      <div class="pr2"><span class="pr2-lbl">Opacit√©</span><input type="range" id="opRange" min="0.05" max="1" step="0.05" value="1" oninput="updateOp(this.value)"><span class="pr2-val" id="opVal">100%</span></div>
    </div>
    <div class="ed-sec">
      <div class="ed-lbl">Texte</div>
      <select class="font-sel" id="fontSel" onchange="applyFont()">
        <option>Arial</option><option>Times New Roman</option><option>Courier New</option>
        <option>Georgia</option><option>Verdana</option><option>Impact</option>
      </select>
      <div class="pr2"><span class="pr2-lbl">Taille</span><input type="range" id="fsRange" min="8" max="120" value="24" oninput="document.getElementById('fsVal').textContent=this.value;applyFont()"><span class="pr2-val" id="fsVal">24</span></div>
      <div class="style-row">
        <button class="sty-btn" type="button" id="boldBtn" onclick="toggleBold()"><strong>G</strong></button>
        <button class="sty-btn" type="button" id="italicBtn" onclick="toggleItalic()"><em>I</em></button>
        <button class="sty-btn" type="button" id="underBtn" onclick="toggleUnder()"><u>S</u></button>
      </div>
    </div>
    <div class="ed-sec">
      <div class="ed-lbl">Format de page</div>
      <div class="pg-presets">
        <div class="pg-btn active" onclick="setPageSize('a4',this)">A4</div>
        <div class="pg-btn" onclick="setPageSize('a3',this)">A3</div>
        <div class="pg-btn" onclick="setPageSize('letter',this)">Letter</div>
        <div class="pg-btn" onclick="setPageSize('16:9',this)">16:9</div>
      </div>
      <div class="import-drop" onclick="document.getElementById('edImport').click()">üñºÔ∏è Importer image ou PDF</div>
      <input type="file" id="edImport" style="display:none" accept="image/*,.pdf">
    </div>
  </div><!-- /ed-side -->

  <!-- CENTER -->
  <div class="ed-center">
    <div class="ed-toolbar">
      <button class="tb" type="button" onclick="undoEd()">‚Ü© Annuler</button>
      <button class="tb" type="button" onclick="redoEd()">‚Ü™ R√©tablir</button>
      <div class="tb-sep"></div>
      <button class="tb" type="button" onclick="dupeSel()">‚ßâ Dupliquer</button>
      <button class="tb" type="button" onclick="delSel()">üóë Supprimer</button>
      <button class="tb" type="button" onclick="fwdSel()">‚Üë Avant</button>
      <button class="tb" type="button" onclick="bwdSel()">‚Üì Arri√®re</button>
      <div class="tb-sep"></div>
      <button class="tb" type="button" onclick="clearEd()" style="color:var(--red)">‚úï Effacer tout</button>
      <div class="tb-sep"></div>
      <button class="tb tb-exp" type="button" onclick="exportPDF()">‚¨á Exporter PDF</button>
      <button class="tb" type="button" onclick="exportPNG()" style="color:var(--blue)">‚¨á PNG</button>
    </div>
    <div class="canvas-wrap"><canvas id="mainCanvas"></canvas></div>
  </div>

  <!-- RIGHT -->
  <div class="ed-props">
    <div class="ed-lbl">Propri√©t√©s</div>
    <div class="no-sel" id="noSelMsg"><span class="no-sel-icon">üëÜ</span>S√©lectionnez un objet pour modifier ses propri√©t√©s.</div>
    <div id="selProps" style="display:none">
      <div class="pr2" style="margin-bottom:7px"><span class="pr2-lbl" style="width:auto">X</span><input class="prop-in" type="number" id="pX" oninput="moveSel()"></div>
      <div class="pr2" style="margin-bottom:7px"><span class="pr2-lbl" style="width:auto">Y</span><input class="prop-in" type="number" id="pY" oninput="moveSel()"></div>
      <div class="pr2" style="margin-bottom:7px"><span class="pr2-lbl" style="width:auto">L</span><input class="prop-in" type="number" id="pW" oninput="sizeSel()"></div>
      <div class="pr2" style="margin-bottom:12px"><span class="pr2-lbl" style="width:auto">H</span><input class="prop-in" type="number" id="pH" oninput="sizeSel()"></div>
      <div class="pr2"><span class="pr2-lbl" style="width:auto">Rotation</span><input type="range" id="pRot" min="-180" max="180" value="0" oninput="document.getElementById('pRotV').textContent=this.value+'¬∞';rotSel()"><span class="pr2-val" id="pRotV">0¬∞</span></div>
      <div style="border-top:1px solid var(--border);margin:12px 0;padding-top:12px">
        <button class="pa" type="button" onclick="centerSel('h')">‚Üî Centrer horiz.</button>
        <button class="pa" type="button" onclick="centerSel('v')">‚Üï Centrer vert.</button>
        <button class="pa pa-del" type="button" onclick="delSel()">üóë Supprimer</button>
      </div>
    </div>
  </div>

</div><!-- /ed-layout -->
</div><!-- /page-editor -->

</div><!-- /main -->

<footer>¬© 2026 Florent Amendola ‚Äî PDF Studio V2.1</footer>

<!-- MODAL -->
<div class="overlay" id="overlay">
  <div class="modal">
    <span class="modal-icon" id="modalIcon">üéâ</span>
    <div class="modal-title" id="modalTitle">Conversion r√©ussie !</div>
    <p class="modal-sub" id="modalSub"></p>
    <div class="modal-btns">
      <button class="btn btn-green" type="button" onclick="downloadAll()">‚¨áÔ∏è T√©l√©charger</button>
      <button class="btn btn-ghost" type="button" onclick="document.getElementById('overlay').classList.remove('show')">Fermer</button>
    </div>
  </div>
</div>

<script>
'use strict';

// ‚îÄ‚îÄ PDF.js ‚îÄ‚îÄ
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONVERTER STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var fileList    = [];
var nextId      = 0;
var mergeOn     = true;
var resultBlobs = [];
var dragSrc     = null;

// ‚îÄ‚îÄ Bootstrap ‚îÄ‚îÄ
window.addEventListener('load', function () {

  // -- File input --
  var inp = document.getElementById('fileInput');

  function openDialog() { inp.click(); }

  inp.addEventListener('change', function () {
    if (this.files && this.files.length > 0) {
      addFiles(this.files);
      // Reset value so same file can be picked again
      try { this.value = ''; } catch(e){}
    }
  });

  // -- Dropzone --
  var dz = document.getElementById('dropzone');

  // Click on dropzone (but not on the button itself ‚Äî button has stopPropagation)
  dz.addEventListener('click', function () { openDialog(); });

  // The button stops propagation so it doesn't double-fire
  document.getElementById('btnChoose').addEventListener('click', function (e) {
    e.stopPropagation();
    openDialog();
  });

  dz.addEventListener('dragenter', function (e) { e.preventDefault(); dz.classList.add('over'); });
  dz.addEventListener('dragover',  function (e) { e.preventDefault(); });
  dz.addEventListener('dragleave', function (e) {
    // Only remove class if leaving the dropzone entirely
    if (!dz.contains(e.relatedTarget)) dz.classList.remove('over');
  });
  dz.addEventListener('drop', function (e) {
    e.preventDefault();
    dz.classList.remove('over');
    if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
      addFiles(e.dataTransfer.files);
    }
  });

  // -- Add more --
  document.getElementById('btnAddMore').addEventListener('click', function () { openDialog(); });

  // -- Merge toggle --
  document.getElementById('mergeToggle').addEventListener('click', function () {
    mergeOn = !mergeOn;
    this.classList.toggle('on', mergeOn);
    document.getElementById('mergeLbl').textContent = mergeOn ? 'Activ√©' : 'D√©sactiv√©';
  });

  // -- Editor import --
  document.getElementById('edImport').addEventListener('change', function () {
    if (this.files && this.files[0]) importDoc(this.files[0]);
    try { this.value = ''; } catch(e){}
  });

  // -- Init Fabric --
  initEditor();
});

// ‚îÄ‚îÄ Add files to list ‚îÄ‚îÄ
function addFiles(rawFiles) {
  var arr = Array.prototype.slice.call(rawFiles);
  arr.forEach(function (f) {
    fileList.push({ id: nextId++, file: f, status: 'ready', thumbUrl: null });
  });
  renderCards();
  updateBadge();
}

function clearAll() {
  fileList = []; resultBlobs = [];
  renderCards(); updateBadge();
  document.getElementById('btnDl').style.display = 'none';
}

function updateBadge() {
  document.getElementById('cntBadge').textContent = fileList.length;
}

// ‚îÄ‚îÄ Render file cards ‚îÄ‚îÄ
function renderCards() {
  var container = document.getElementById('fileCards');
  container.innerHTML = '';

  if (fileList.length === 0) {
    container.innerHTML =
      '<div class="empty-state"><span class="empty-icon">üìã</span>' +
      'Aucun fichier.<br>Utilisez la zone ci-dessus pour en ajouter.</div>';
    return;
  }

  fileList.forEach(function (entry, idx) {
    var card = document.createElement('div');
    card.className = 'file-card';
    card.draggable = true;

    var stCls = { ready:'s-ready', working:'s-working', done:'s-done', error:'s-error' }[entry.status] || 's-ready';
    var stTxt = { ready:'Pr√™t', working:'‚è≥‚Ä¶', done:'‚úì OK', error:'‚úó Erreur' }[entry.status] || 'Pr√™t';
    var ext   = entry.file.name.split('.').pop().toUpperCase();
    var icon  = fileIcon(entry.file);

    var thumbHtml = entry.thumbUrl
      ? '<img src="' + entry.thumbUrl + '">'
      : '<span>' + icon + '</span>';

    card.innerHTML =
      '<div class="drag-handle" title="Glisser pour r√©ordonner">‚†ø</div>' +
      '<div class="fc-num">' + (idx + 1) + '</div>' +
      '<div class="fc-thumb">' + thumbHtml + '</div>' +
      '<div class="fc-info">' +
        '<div class="fc-name" title="' + entry.file.name + '">' + entry.file.name + '</div>' +
        '<div class="fc-meta"><span>' + fmtSize(entry.file.size) + '</span><span>' + ext + '</span></div>' +
      '</div>' +
      '<span class="fc-status ' + stCls + '" id="st-' + entry.id + '">' + stTxt + '</span>' +
      '<button class="fc-del" type="button" data-id="' + entry.id + '" title="Supprimer">‚úï</button>';

    // Delete
    card.querySelector('.fc-del').addEventListener('click', function (e) {
      e.stopPropagation();
      var rid = parseInt(this.getAttribute('data-id'));
      fileList = fileList.filter(function (x) { return x.id !== rid; });
      renderCards(); updateBadge();
      if (fileList.length === 0) document.getElementById('btnDl').style.display = 'none';
    });

    // Drag-to-reorder
    card.addEventListener('dragstart', function (e) {
      dragSrc = idx;
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', String(idx)); // required for Firefox
      setTimeout(function () { card.classList.add('dragging'); }, 0);
    });
    card.addEventListener('dragend', function () { card.classList.remove('dragging'); });
    card.addEventListener('dragover', function (e) { e.preventDefault(); card.classList.add('drag-over'); });
    card.addEventListener('dragleave', function () { card.classList.remove('drag-over'); });
    card.addEventListener('drop', function (e) {
      e.preventDefault(); e.stopPropagation();
      card.classList.remove('drag-over');
      if (dragSrc === null || dragSrc === idx) return;
      var moved = fileList.splice(dragSrc, 1)[0];
      fileList.splice(idx, 0, moved);
      dragSrc = null;
      renderCards();
    });

    container.appendChild(card);

    // Thumbnail for images
    if (entry.file.type.startsWith('image/') && !entry.thumbUrl) {
      (function (ent, cardEl) {
        var reader = new FileReader();
        reader.onload = function (ev) {
          ent.thumbUrl = ev.target.result;
          var th = cardEl.querySelector('.fc-thumb');
          if (th) th.innerHTML = '<img src="' + ev.target.result + '">';
        };
        reader.readAsDataURL(ent.file);
      }(entry, card));
    }
  });
}

function fileIcon(f) {
  if (f.type.startsWith('image/')) return 'üñºÔ∏è';
  if (f.type === 'application/pdf') return 'üìÑ';
  if (f.name.match(/\.docx?$/i)) return 'üìù';
  if (f.type === 'text/plain') return 'üìÉ';
  if (f.type === 'text/html') return 'üåê';
  return 'üìÅ';
}

function fmtSize(b) {
  if (b < 1024) return b + ' o';
  if (b < 1048576) return (b/1024).toFixed(1) + ' Ko';
  return (b/1048576).toFixed(1) + ' Mo';
}

// ‚îÄ‚îÄ Conversion ‚îÄ‚îÄ
function setStatus(id, st) {
  var el = document.getElementById('st-' + id);
  if (!el) return;
  var c = { ready:'s-ready', working:'s-working', done:'s-done', error:'s-error' }[st] || 's-ready';
  var t = { ready:'Pr√™t', working:'‚è≥‚Ä¶', done:'‚úì OK', error:'‚úó Erreur' }[st] || st;
  el.className = 'fc-status ' + c;
  el.textContent = t;
}

function setProgress(pct, step) {
  document.getElementById('progFill').style.width = pct + '%';
  document.getElementById('progStep').textContent = step || '';
}

async function runConvert() {
  if (fileList.length === 0) { showToast('Ajoutez d\'abord des fichiers !', 'err'); return; }

  document.getElementById('progWrap').classList.add('show');
  setProgress(0, 'D√©marrage‚Ä¶');
  resultBlobs = [];

  var fmt    = document.getElementById('optFmt').value;
  var ori    = document.getElementById('optOri').value;
  var margin = parseInt(document.getElementById('optMargin').value) || 10;

  for (var i = 0; i < fileList.length; i++) {
    var entry = fileList[i];
    setStatus(entry.id, 'working');
    setProgress(Math.round(i / fileList.length * 80), 'Conversion : ' + entry.file.name);
    try {
      var blob = await fileToPDF(entry.file, fmt, ori, margin);
      entry.status = 'done';
      resultBlobs.push({ blob: blob, name: entry.file.name.replace(/\.[^.]+$/, '') + '.pdf' });
      setStatus(entry.id, 'done');
    } catch (err) {
      console.error(err);
      entry.status = 'error';
      setStatus(entry.id, 'error');
    }
  }

  setProgress(90, 'Finalisation‚Ä¶');

  if (mergeOn && resultBlobs.length > 1) {
    setProgress(95, 'Fusion‚Ä¶');
    try {
      var merged = await mergePDFs(resultBlobs.map(function (r) { return r.blob; }));
      resultBlobs = [{ blob: merged, name: 'document-fusionne.pdf' }];
    } catch (e) { console.error(e); }
  }

  setProgress(100, 'Termin√© !');
  setTimeout(function () { document.getElementById('progWrap').classList.remove('show'); }, 700);

  var done = fileList.filter(function (x) { return x.status === 'done'; }).length;
  var btnDl = document.getElementById('btnDl');
  btnDl.style.display = 'inline-flex';
  btnDl.textContent = (mergeOn && done > 1) ? '‚¨áÔ∏è PDF fusionn√©' : '‚¨áÔ∏è T√©l√©charger ' + done + ' PDF';

  var isMerge = mergeOn && done > 1;
  document.getElementById('modalIcon').textContent  = isMerge ? 'üéä' : 'üéâ';
  document.getElementById('modalTitle').textContent = isMerge ? 'PDF fusionn√© pr√™t !' : done + ' PDF pr√™t' + (done > 1 ? 's' : '') + ' !';
  document.getElementById('modalSub').textContent   = isMerge
    ? 'Vos ' + done + ' fichiers ont √©t√© fusionn√©s en un seul PDF.'
    : 'Vos fichiers ont bien √©t√© convertis en PDF.';
  document.getElementById('overlay').classList.add('show');
}

function downloadAll() {
  resultBlobs.forEach(function (r) {
    var url = URL.createObjectURL(r.blob);
    var a = document.createElement('a');
    a.href = url; a.download = r.name;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    setTimeout(function () { URL.revokeObjectURL(url); }, 2000);
  });
  document.getElementById('overlay').classList.remove('show');
}

// ‚îÄ‚îÄ PDF helpers ‚îÄ‚îÄ
async function fileToPDF(file, fmt, ori, margin) {
  var pdf = new window.jspdf.jsPDF({ orientation: ori, unit: 'mm', format: fmt });
  var pw  = pdf.internal.pageSize.getWidth();
  var ph  = pdf.internal.pageSize.getHeight();
  if (file.type.startsWith('image/') || file.name.match(/\.(heic|heif|webp)$/i))
    return imgToPDF(file, pdf, pw, ph, margin);
  if (file.type === 'application/pdf')
    return pdfRerender(file, pdf, pw, ph, margin);
  if (file.type === 'text/plain')
    return textToPDF(await file.text(), pdf, pw, ph, margin);
  if (file.type === 'text/html' || file.name.match(/\.html?$/i)) {
    var div = document.createElement('div');
    div.innerHTML = await file.text();
    return textToPDF(div.innerText || div.textContent || '', pdf, pw, ph, margin);
  }
  var ab  = await file.arrayBuffer();
  var raw = new TextDecoder('utf-8', { fatal: false }).decode(new Uint8Array(ab));
  var txt = raw.replace(/[^\x20-\x7E\n\r\t]/g, ' ').replace(/\s{3,}/g, '\n').trim();
  return textToPDF(txt || ('Fichier : ' + file.name), pdf, pw, ph, margin);
}

function imgToPDF(file, pdf, pw, ph, margin) {
  return new Promise(function (resolve, reject) {
    var reader = new FileReader();
    reader.onerror = reject;
    reader.onload = function (ev) {
      var img = new Image();
      img.onerror = reject;
      img.onload = function () {
        var usW = pw - margin * 2, usH = ph - margin * 2;
        var iw = usW, ih = img.height / img.width * usW;
        if (ih > usH) { ih = usH; iw = img.width / img.height * usH; }
        var cvs = document.createElement('canvas');
        cvs.width = img.width; cvs.height = img.height;
        cvs.getContext('2d').drawImage(img, 0, 0);
        pdf.addImage(cvs.toDataURL('image/jpeg', 0.92), 'JPEG', (pw-iw)/2, (ph-ih)/2, iw, ih);
        resolve(pdf.output('blob'));
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });
}

async function pdfRerender(file, pdf, pw, ph, margin) {
  var ab  = await file.arrayBuffer();
  var doc = await pdfjsLib.getDocument({ data: ab }).promise;
  for (var p = 1; p <= doc.numPages; p++) {
    if (p > 1) pdf.addPage();
    var page = await doc.getPage(p);
    var vp   = page.getViewport({ scale: 2 });
    var cvs  = document.createElement('canvas');
    cvs.width = vp.width; cvs.height = vp.height;
    await page.render({ canvasContext: cvs.getContext('2d'), viewport: vp }).promise;
    var usW = pw-margin*2, usH = ph-margin*2;
    var iw = usW, ih = cvs.height/cvs.width*usW;
    if (ih > usH) { ih = usH; iw = cvs.width/cvs.height*usH; }
    pdf.addImage(cvs.toDataURL('image/jpeg', 0.9), 'JPEG', (pw-iw)/2, (ph-ih)/2, iw, ih);
  }
  return pdf.output('blob');
}

function textToPDF(txt, pdf, pw, ph, margin) {
  pdf.setFontSize(11); pdf.setTextColor(30, 30, 30);
  var lines = pdf.splitTextToSize(txt, pw - margin * 2);
  var y = margin + 10;
  lines.forEach(function (line) {
    if (y + 6 > ph - margin) { pdf.addPage(); y = margin + 10; }
    pdf.text(line, margin, y); y += 6;
  });
  return Promise.resolve(pdf.output('blob'));
}

async function mergePDFs(blobs) {
  var merged = new window.jspdf.jsPDF({ unit: 'px', format: 'a4' });
  var first  = true;
  for (var i = 0; i < blobs.length; i++) {
    var ab  = await blobs[i].arrayBuffer();
    var doc = await pdfjsLib.getDocument({ data: ab }).promise;
    for (var p = 1; p <= doc.numPages; p++) {
      if (!first) merged.addPage(); first = false;
      var page = await doc.getPage(p);
      var vp   = page.getViewport({ scale: 2 });
      var cvs  = document.createElement('canvas');
      cvs.width = vp.width; cvs.height = vp.height;
      await page.render({ canvasContext: cvs.getContext('2d'), viewport: vp }).promise;
      merged.internal.pageSize.width  = vp.width;
      merged.internal.pageSize.height = vp.height;
      merged.addImage(cvs.toDataURL('image/jpeg', 0.9), 'JPEG', 0, 0, vp.width, vp.height);
    }
  }
  return merged.output('blob');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EDITOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var canvas;
var curTool  = 'select';
var fillC    = '#4361ee';
var strokeC  = '#1a1d2e';
var sw       = 2;
var isDrawing = false, drawStart = null, tmpShape = null;
var edHist = [], edHIdx = -1;

function initEditor() {
  canvas = new fabric.Canvas('mainCanvas', {
    backgroundColor: '#ffffff',
    preserveObjectStacking: true,
  });
  setPageSize('a4', document.querySelector('.pg-btn.active'));

  canvas.on('object:added',    saveH);
  canvas.on('object:modified', saveH);
  canvas.on('object:removed',  saveH);
  canvas.on('selection:created', showSelProps);
  canvas.on('selection:updated', showSelProps);
  canvas.on('selection:cleared', function () {
    document.getElementById('noSelMsg').style.display = 'block';
    document.getElementById('selProps').style.display = 'none';
  });
  canvas.on('mouse:down', edDown);
  canvas.on('mouse:move', edMove);
  canvas.on('mouse:up',   edUp);
}

function setPageSize(p, el) {
  document.querySelectorAll('.pg-btn').forEach(function (b) { b.classList.remove('active'); });
  if (el) el.classList.add('active');
  var s = { a4:[794,1123], a3:[1123,1587], letter:[816,1056], '16:9':[1280,720] }[p] || [794,1123];
  canvas.setWidth(s[0]); canvas.setHeight(s[1]); canvas.renderAll();
}

function setTool(t) {
  curTool = t;
  document.querySelectorAll('.t-btn').forEach(function (b) { b.classList.remove('active'); });
  var btn = document.getElementById('tb-' + t);
  if (btn) btn.classList.add('active');
  canvas.isDrawingMode = (t === 'draw');
  if (t === 'draw') {
    canvas.freeDrawingBrush.color = strokeC === 'transparent' ? '#000' : strokeC;
    canvas.freeDrawingBrush.width = sw;
  }
  canvas.selection     = (t === 'select');
  canvas.defaultCursor = t === 'select' ? 'default' : t === 'text' ? 'text' : 'crosshair';
}

function edDown(opt) {
  if (curTool === 'select' || curTool === 'draw') return;
  if (curTool === 'erase') { if (opt.target) { canvas.remove(opt.target); canvas.renderAll(); } return; }
  if (curTool === 'text') {
    var ptr = canvas.getPointer(opt.e);
    var t = new fabric.IText('Votre texte ici', {
      left: ptr.x, top: ptr.y,
      fontFamily: document.getElementById('fontSel').value,
      fontSize:   parseInt(document.getElementById('fsRange').value),
      fill: fillC === 'transparent' ? '#000' : fillC,
    });
    canvas.add(t); canvas.setActiveObject(t); t.enterEditing(); return;
  }
  isDrawing = true;
  drawStart = canvas.getPointer(opt.e);
  var o = {
    left: drawStart.x, top: drawStart.y,
    fill:        fillC   === 'transparent' ? '' : fillC,
    stroke:      strokeC === 'transparent' ? '' : strokeC,
    strokeWidth: sw,
    opacity:     parseFloat(document.getElementById('opRange').value),
    selectable:  false,
  };
  if (curTool === 'rect')   tmpShape = new fabric.Rect(Object.assign({}, o, { width:0, height:0, rx:3, ry:3 }));
  if (curTool === 'circle') tmpShape = new fabric.Ellipse(Object.assign({}, o, { rx:0, ry:0 }));
  if (curTool === 'line')   tmpShape = new fabric.Line([drawStart.x,drawStart.y,drawStart.x,drawStart.y], { stroke: strokeC==='transparent'?'#000':strokeC, strokeWidth:sw, selectable:false });
  if (tmpShape) canvas.add(tmpShape);
}

function edMove(opt) {
  if (!isDrawing || !tmpShape) return;
  var ptr = canvas.getPointer(opt.e);
  var dx = ptr.x - drawStart.x, dy = ptr.y - drawStart.y;
  if (curTool === 'rect')   tmpShape.set({ left:dx<0?ptr.x:drawStart.x, top:dy<0?ptr.y:drawStart.y, width:Math.abs(dx), height:Math.abs(dy) });
  if (curTool === 'circle') tmpShape.set({ left:dx>0?drawStart.x:ptr.x, top:dy>0?drawStart.y:ptr.y, rx:Math.abs(dx)/2, ry:Math.abs(dy)/2 });
  if (curTool === 'line')   tmpShape.set({ x2:ptr.x, y2:ptr.y });
  canvas.renderAll();
}

function edUp() {
  if (!isDrawing) return;
  isDrawing = false;
  if (tmpShape) { tmpShape.set({ selectable:true }); canvas.setActiveObject(tmpShape); tmpShape = null; setTool('select'); }
}

function addArrow() {
  var cx = canvas.width/2, cy = canvas.height/2;
  var col = strokeC === 'transparent' ? '#4361ee' : strokeC;
  var g = new fabric.Group([
    new fabric.Line([cx-80,cy,cx+65,cy], { stroke:col, strokeWidth:sw||3 }),
    new fabric.Triangle({ width:16, height:14, fill:col, left:cx+57, top:cy-7, angle:90 }),
  ]);
  canvas.add(g); canvas.setActiveObject(g); canvas.renderAll();
}

function addSym(s) {
  var t = new fabric.Text(s, { left:canvas.width/2-20, top:canvas.height/2-20, fontSize:42, fill:fillC==='transparent'?'#4361ee':fillC });
  canvas.add(t); canvas.setActiveObject(t); canvas.renderAll();
}

function applyProp(k, v) {
  var o = canvas.getActiveObject(); if (!o) return;
  if (o.type === 'activeSelection') o.getObjects().forEach(function (i) { i.set(k,v); });
  else o.set(k, v);
  canvas.renderAll();
}

function pickFill(el) {
  document.querySelectorAll('#fillSw .sw').forEach(function (s) { s.classList.remove('sel'); });
  el.classList.add('sel');
  fillC = el.getAttribute('data-c');
  if (fillC !== 'transparent') document.getElementById('fillPicker').value = fillC;
  applyProp('fill', fillC === 'transparent' ? '' : fillC);
}
function setFillC(v) { fillC = v; applyProp('fill', v); }

function pickStroke(el) {
  document.querySelectorAll('#strokeSw .sw').forEach(function (s) { s.classList.remove('sel'); });
  el.classList.add('sel');
  strokeC = el.getAttribute('data-c');
  if (strokeC !== 'transparent') document.getElementById('strokePicker').value = strokeC;
  applyProp('stroke', strokeC === 'transparent' ? '' : strokeC);
  if (canvas.isDrawingMode) canvas.freeDrawingBrush.color = strokeC === 'transparent' ? '#000' : strokeC;
}
function setStrokeC(v) { strokeC = v; applyProp('stroke', v); if (canvas.isDrawingMode) canvas.freeDrawingBrush.color = v; }

function updateSW(v) { sw = parseInt(v); document.getElementById('swVal').textContent = v; applyProp('strokeWidth', sw); if (canvas.isDrawingMode) canvas.freeDrawingBrush.width = sw; }
function updateOp(v) { document.getElementById('opVal').textContent = Math.round(v*100)+'%'; applyProp('opacity', parseFloat(v)); }
function applyFont() { var o=canvas.getActiveObject(); if(!o||(o.type!=='i-text'&&o.type!=='text'))return; o.set({fontFamily:document.getElementById('fontSel').value,fontSize:parseInt(document.getElementById('fsRange').value)}); canvas.renderAll(); }
function toggleBold()   { var o=canvas.getActiveObject();if(!o)return;o.set('fontWeight',o.fontWeight==='bold'?'normal':'bold');document.getElementById('boldBtn').classList.toggle('on',o.fontWeight==='bold');canvas.renderAll(); }
function toggleItalic() { var o=canvas.getActiveObject();if(!o)return;o.set('fontStyle',o.fontStyle==='italic'?'normal':'italic');document.getElementById('italicBtn').classList.toggle('on',o.fontStyle==='italic');canvas.renderAll(); }
function toggleUnder()  { var o=canvas.getActiveObject();if(!o)return;o.set('underline',!o.underline);document.getElementById('underBtn').classList.toggle('on',o.underline);canvas.renderAll(); }

function dupeSel() { var o=canvas.getActiveObject();if(!o)return;o.clone(function(c){c.set({left:o.left+18,top:o.top+18});canvas.add(c);canvas.setActiveObject(c);canvas.renderAll();}); }
function delSel()  { var o=canvas.getActiveObject();if(!o)return;if(o.type==='activeSelection'){o.getObjects().forEach(function(i){canvas.remove(i);});canvas.discardActiveObject();}else{canvas.remove(o);}canvas.renderAll(); }
function fwdSel()  { var o=canvas.getActiveObject();if(o){canvas.bringForward(o);canvas.renderAll();} }
function bwdSel()  { var o=canvas.getActiveObject();if(o){canvas.sendBackwards(o);canvas.renderAll();} }
function clearEd() { if(!confirm('Effacer tout le contenu ?'))return;canvas.clear();canvas.backgroundColor='#ffffff';canvas.renderAll(); }
function centerSel(axis) { var o=canvas.getActiveObject();if(!o)return;if(axis==='h')o.set('left',(canvas.width-o.getScaledWidth())/2);if(axis==='v')o.set('top',(canvas.height-o.getScaledHeight())/2);o.setCoords();canvas.renderAll(); }

function showSelProps() {
  var o=canvas.getActiveObject();if(!o)return;
  document.getElementById('noSelMsg').style.display='none';
  document.getElementById('selProps').style.display='block';
  document.getElementById('pX').value=Math.round(o.left);
  document.getElementById('pY').value=Math.round(o.top);
  document.getElementById('pW').value=Math.round(o.getScaledWidth());
  document.getElementById('pH').value=Math.round(o.getScaledHeight());
  document.getElementById('pRot').value=Math.round(o.angle);
  document.getElementById('pRotV').textContent=Math.round(o.angle)+'¬∞';
}
function moveSel() { var o=canvas.getActiveObject();if(!o)return;o.set({left:parseInt(document.getElementById('pX').value),top:parseInt(document.getElementById('pY').value)});o.setCoords();canvas.renderAll(); }
function sizeSel() { var o=canvas.getActiveObject();if(!o)return;o.set({scaleX:parseInt(document.getElementById('pW').value)/o.width,scaleY:parseInt(document.getElementById('pH').value)/o.height});o.setCoords();canvas.renderAll(); }
function rotSel()  { var o=canvas.getActiveObject();if(!o)return;o.set('angle',parseInt(document.getElementById('pRot').value));o.setCoords();canvas.renderAll(); }

function saveH() { var j=JSON.stringify(canvas.toJSON());edHist=edHist.slice(0,edHIdx+1);edHist.push(j);edHIdx=edHist.length-1; }
function undoEd() { if(edHIdx<=0)return;edHIdx--;canvas.loadFromJSON(edHist[edHIdx],function(){canvas.renderAll();}); }
function redoEd() { if(edHIdx>=edHist.length-1)return;edHIdx++;canvas.loadFromJSON(edHist[edHIdx],function(){canvas.renderAll();}); }

async function importDoc(file) {
  if (file.type.startsWith('image/')) {
    var r = new FileReader();
    r.onload = function (ev) {
      fabric.Image.fromURL(ev.target.result, function (img) {
        var mW = canvas.width * 0.9;
        if (img.width > mW) { var s=mW/img.width; img.scaleX=s; img.scaleY=s; }
        img.set({left:10,top:10}); canvas.add(img); canvas.setActiveObject(img); canvas.renderAll();
      });
    };
    r.readAsDataURL(file);
  } else if (file.type === 'application/pdf') {
    var ab  = await file.arrayBuffer();
    var doc = await pdfjsLib.getDocument({ data: ab }).promise;
    var page = await doc.getPage(1);
    var vp   = page.getViewport({ scale: 1.5 });
    var cvs  = document.createElement('canvas');
    cvs.width = vp.width; cvs.height = vp.height;
    await page.render({ canvasContext: cvs.getContext('2d'), viewport: vp }).promise;
    fabric.Image.fromURL(cvs.toDataURL(), function (img) {
      var mW = canvas.width * 0.95;
      if (img.width > mW) { var s=mW/img.width; img.scaleX=s; img.scaleY=s; }
      img.set({left:5,top:5}); canvas.add(img); canvas.sendToBack(img); canvas.renderAll();
    });
    showToast('PDF import√© ‚Äî annotez maintenant !', 'ok');
  }
}

function exportPDF() {
  var w=canvas.width, h=canvas.height;
  var du=canvas.toDataURL({format:'jpeg',quality:0.95});
  var pdf=new window.jspdf.jsPDF({orientation:w>h?'landscape':'portrait',unit:'px',format:[w,h]});
  pdf.addImage(du,'JPEG',0,0,w,h);
  pdf.save('document-edite.pdf');
  showToast('PDF export√© ! üéâ', 'ok');
}
function exportPNG() {
  var a=document.createElement('a');
  a.href=canvas.toDataURL({format:'png',multiplier:2});
  a.download='document.png';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  showToast('PNG export√© !', 'ok');
}

// ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ
function goPage(id) {
  document.querySelectorAll('.page').forEach(function (p) { p.classList.remove('active'); });
  document.querySelectorAll('.nav-tab').forEach(function (t) { t.classList.remove('active'); });
  document.getElementById('page-' + id).classList.add('active');
  document.getElementById('tab-' + id).classList.add('active');
}

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
var _tt;
function showToast(msg, type) {
  var old = document.querySelector('.toast'); if (old) old.remove();
  clearTimeout(_tt);
  var el = document.createElement('div');
  el.className = 'toast' + (type ? ' ' + type : '');
  el.textContent = msg;
  document.body.appendChild(el);
  _tt = setTimeout(function () { if (el.parentNode) el.remove(); }, 3000);
}
</script>
</body>
</html>
