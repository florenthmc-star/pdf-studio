<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PDF Studio Pro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap');

  :root {
    --bg: #0d0f14;
    --surface: #161922;
    --surface2: #1e2230;
    --border: #2a2f42;
    --accent: #4f7cff;
    --accent2: #7c4fff;
    --success: #2dd68c;
    --text: #e8eaf0;
    --text2: #8890a8;
    --danger: #ff4f6a;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* HEADER */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 32px;
    border-bottom: 1px solid var(--border);
    background: rgba(13,15,20,0.95);
    backdrop-filter: blur(20px);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 1.4rem;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: -0.5px;
  }

  .logo span { -webkit-text-fill-color: var(--text); }

  .tabs {
    display: flex;
    gap: 4px;
    background: var(--surface);
    padding: 4px;
    border-radius: 12px;
    border: 1px solid var(--border);
  }

  .tab {
    padding: 8px 22px;
    border: none;
    background: transparent;
    color: var(--text2);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.88rem;
    font-weight: 500;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .tab.active {
    background: var(--accent);
    color: #fff;
  }

  .tab:hover:not(.active) { background: var(--surface2); color: var(--text); }

  /* PAGES */
  .page { display: none; padding: 32px; }
  .page.active { display: block; }

  /* CONVERTER PAGE */
  .converter-layout {
    display: grid;
    grid-template-columns: 1fr 360px;
    gap: 24px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .drop-zone {
    border: 2px dashed var(--border);
    border-radius: 20px;
    padding: 64px 32px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: var(--surface);
    position: relative;
    overflow: hidden;
  }

  .drop-zone::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(ellipse at center, rgba(79,124,255,0.05) 0%, transparent 70%);
    opacity: 0;
    transition: opacity 0.3s;
  }

  .drop-zone.dragover, .drop-zone:hover {
    border-color: var(--accent);
    background: var(--surface2);
  }

  .drop-zone.dragover::before, .drop-zone:hover::before { opacity: 1; }

  .drop-icon {
    width: 72px;
    height: 72px;
    margin: 0 auto 20px;
    background: linear-gradient(135deg, rgba(79,124,255,0.2), rgba(124,79,255,0.2));
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
  }

  .drop-title {
    font-family: 'Syne', sans-serif;
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 8px;
  }

  .drop-sub {
    color: var(--text2);
    font-size: 0.88rem;
    line-height: 1.6;
    margin-bottom: 24px;
  }

  .formats {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: center;
    margin-bottom: 24px;
  }

  .fmt-badge {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.5px;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text2);
  }

  .btn {
    padding: 11px 24px;
    border: none;
    border-radius: 10px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 500;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .btn-primary {
    background: var(--accent);
    color: #fff;
  }

  .btn-primary:hover { background: #3d6ae8; transform: translateY(-1px); }

  .btn-success {
    background: var(--success);
    color: #0d1a10;
  }

  .btn-success:hover { background: #24c07d; }

  .btn-ghost {
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
  }

  .btn-ghost:hover { background: var(--border); }

  .btn-danger {
    background: rgba(255,79,106,0.15);
    color: var(--danger);
    border: 1px solid rgba(255,79,106,0.3);
  }

  .btn-danger:hover { background: rgba(255,79,106,0.25); }

  #fileInput { display: none; }

  /* FILE LIST */
  .file-panel {
    background: var(--surface);
    border-radius: 20px;
    border: 1px solid var(--border);
    overflow: hidden;
  }

  .file-panel-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .file-panel-title {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 1rem;
  }

  .file-list {
    padding: 12px;
    max-height: 400px;
    overflow-y: auto;
  }

  .file-list::-webkit-scrollbar { width: 4px; }
  .file-list::-webkit-scrollbar-track { background: transparent; }
  .file-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .file-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    border-radius: 10px;
    background: var(--surface2);
    margin-bottom: 8px;
    border: 1px solid var(--border);
    animation: slideIn 0.2s ease;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .file-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    flex-shrink: 0;
  }

  .file-icon.img { background: rgba(79,124,255,0.2); }
  .file-icon.doc { background: rgba(79,199,255,0.2); }
  .file-icon.pdf { background: rgba(255,79,106,0.2); }
  .file-icon.other { background: rgba(124,79,255,0.2); }

  .file-info { flex: 1; min-width: 0; }

  .file-name {
    font-size: 0.85rem;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .file-size { font-size: 0.75rem; color: var(--text2); }

  .file-status {
    font-size: 0.75rem;
    padding: 3px 8px;
    border-radius: 5px;
    font-weight: 600;
  }

  .status-ready { background: rgba(79,124,255,0.15); color: var(--accent); }
  .status-done { background: rgba(45,214,140,0.15); color: var(--success); }
  .status-error { background: rgba(255,79,106,0.15); color: var(--danger); }

  .file-remove {
    background: none;
    border: none;
    color: var(--text2);
    cursor: pointer;
    font-size: 1rem;
    padding: 2px 6px;
    border-radius: 4px;
    transition: all 0.2s;
    flex-shrink: 0;
  }

  .file-remove:hover { background: rgba(255,79,106,0.15); color: var(--danger); }

  .panel-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .convert-all-btn {
    width: 100%;
    justify-content: center;
    padding: 13px;
    font-size: 0.95rem;
    font-weight: 600;
    border-radius: 12px;
  }

  .empty-state {
    padding: 32px;
    text-align: center;
    color: var(--text2);
    font-size: 0.88rem;
  }

  /* EDITOR PAGE */
  .editor-layout {
    display: grid;
    grid-template-columns: 260px 1fr 220px;
    gap: 0;
    height: calc(100vh - 80px);
    margin: -32px;
  }

  .editor-sidebar {
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .editor-sidebar-section {
    padding: 16px;
    border-bottom: 1px solid var(--border);
  }

  .section-label {
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 1.2px;
    text-transform: uppercase;
    color: var(--text2);
    margin-bottom: 10px;
  }

  .tool-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
  }

  .tool-btn {
    padding: 10px 8px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }

  .tool-btn .tool-icon { font-size: 1.2rem; }

  .tool-btn:hover, .tool-btn.active {
    background: rgba(79,124,255,0.15);
    border-color: var(--accent);
    color: var(--accent);
  }

  /* Color palette */
  .color-palette {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 10px;
  }

  .color-swatch {
    width: 24px;
    height: 24px;
    border-radius: 6px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.15s;
  }

  .color-swatch.selected { border-color: #fff; transform: scale(1.15); }

  .color-input-row {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  input[type="color"] {
    width: 36px;
    height: 36px;
    border: none;
    background: none;
    cursor: pointer;
    border-radius: 8px;
    padding: 0;
  }

  .prop-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
    gap: 8px;
  }

  .prop-label { font-size: 0.8rem; color: var(--text2); flex-shrink: 0; }

  input[type="range"] {
    flex: 1;
    accent-color: var(--accent);
    height: 4px;
  }

  .prop-val { font-size: 0.8rem; min-width: 28px; text-align: right; }

  select {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 10px;
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.83rem;
    width: 100%;
    cursor: pointer;
  }

  input[type="text"], input[type="number"] {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 7px 10px;
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.83rem;
    width: 100%;
  }

  /* Canvas area */
  .editor-canvas-area {
    background: #1a1a2e;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .editor-toolbar {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 8px 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .toolbar-sep {
    width: 1px;
    height: 24px;
    background: var(--border);
    margin: 0 4px;
  }

  .toolbar-btn {
    padding: 6px 12px;
    background: transparent;
    border: 1px solid transparent;
    border-radius: 7px;
    color: var(--text2);
    font-size: 0.82rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 5px;
    font-family: 'DM Sans', sans-serif;
  }

  .toolbar-btn:hover { background: var(--surface2); color: var(--text); border-color: var(--border); }

  .canvas-wrapper {
    flex: 1;
    overflow: auto;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 32px;
  }

  .canvas-wrapper::-webkit-scrollbar { width: 8px; height: 8px; }
  .canvas-wrapper::-webkit-scrollbar-track { background: transparent; }
  .canvas-wrapper::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  #fabricCanvas {
    border-radius: 4px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  }

  /* Properties panel */
  .props-panel {
    background: var(--surface);
    border-left: 1px solid var(--border);
    overflow-y: auto;
    padding: 16px;
  }

  .props-panel::-webkit-scrollbar { width: 4px; }
  .props-panel::-webkit-scrollbar-thumb { background: var(--border); }

  .no-selection {
    text-align: center;
    color: var(--text2);
    font-size: 0.83rem;
    padding: 32px 16px;
  }

  /* Upload for editor */
  .editor-upload-zone {
    border: 2px dashed var(--border);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.83rem;
    color: var(--text2);
    margin: 12px 0;
  }

  .editor-upload-zone:hover { border-color: var(--accent); color: var(--accent); }

  /* Progress bar */
  .progress-bar {
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 8px;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 2px;
    transition: width 0.3s;
    width: 0%;
  }

  /* Notification */
  .notif {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 20px;
    font-size: 0.88rem;
    z-index: 9999;
    animation: notifIn 0.3s ease;
    max-width: 320px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  @keyframes notifIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .notif.success { border-color: var(--success); }
  .notif.error { border-color: var(--danger); }

  /* Page size selector */
  .page-sizes {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
  }

  .size-btn {
    padding: 8px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text2);
    font-size: 0.78rem;
    cursor: pointer;
    text-align: center;
    transition: all 0.2s;
  }

  .size-btn:hover, .size-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(79,124,255,0.1); }

  .sidebar-scroll { overflow-y: auto; flex: 1; }
  .sidebar-scroll::-webkit-scrollbar { width: 3px; }
  .sidebar-scroll::-webkit-scrollbar-thumb { background: var(--border); }

  .text-style-row {
    display: flex;
    gap: 4px;
    margin-bottom: 8px;
  }

  .style-toggle {
    flex: 1;
    padding: 7px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 7px;
    color: var(--text2);
    cursor: pointer;
    font-size: 0.85rem;
    text-align: center;
    transition: all 0.2s;
    font-family: 'DM Sans', sans-serif;
  }

  .style-toggle:hover, .style-toggle.on { background: rgba(79,124,255,0.15); border-color: var(--accent); color: var(--accent); }

  .align-row {
    display: flex;
    gap: 4px;
    margin-bottom: 8px;
  }

  .badge-count {
    background: var(--accent);
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 0.7rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
  }
</style>
</head>
<body>

<header>
  <div class="logo">PDF<span> Studio</span> Pro</div>
  <div class="tabs">
    <button class="tab active" onclick="showPage('converter')">üìÑ Convertir en PDF</button>
    <button class="tab" onclick="showPage('editor')">‚úèÔ∏è √âditeur de documents</button>
  </div>
  <div style="width:160px"></div>
</header>

<!-- CONVERTER PAGE -->
<div class="page active" id="page-converter">
  <div class="converter-layout">
    <div>
      <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
        <div class="drop-icon">üìÇ</div>
        <div class="drop-title">D√©posez vos fichiers ici</div>
        <div class="drop-sub">Ou cliquez pour parcourir vos fichiers<br>Tous les formats sont accept√©s</div>
        <div class="formats">
          <span class="fmt-badge">JPG</span><span class="fmt-badge">PNG</span>
          <span class="fmt-badge">HEIC</span><span class="fmt-badge">WebP</span>
          <span class="fmt-badge">GIF</span><span class="fmt-badge">BMP</span>
          <span class="fmt-badge">TIFF</span><span class="fmt-badge">DOC/DOCX</span>
          <span class="fmt-badge">TXT</span><span class="fmt-badge">HTML</span>
          <span class="fmt-badge">PDF</span>
        </div>
        <button class="btn btn-primary" onclick="event.stopPropagation(); document.getElementById('fileInput').click()">
          <span>Ôºã</span> S√©lectionner des fichiers
        </button>
        <input type="file" id="fileInput" multiple accept="image/*,.pdf,.doc,.docx,.txt,.html,.htm,.heic,.heif,.webp" onchange="handleFiles(this.files)">
      </div>

      <div style="margin-top:20px; background:var(--surface); border-radius:16px; border:1px solid var(--border); padding:20px;">
        <div class="section-label" style="margin-bottom:12px">Options de conversion</div>
        <div class="prop-row">
          <span class="prop-label">Format de page</span>
          <select id="pageFormat" style="width:120px">
            <option value="a4">A4</option>
            <option value="a3">A3</option>
            <option value="letter">Letter</option>
            <option value="legal">Legal</option>
          </select>
        </div>
        <div class="prop-row">
          <span class="prop-label">Orientation</span>
          <select id="pageOrient" style="width:120px">
            <option value="portrait">Portrait</option>
            <option value="landscape">Paysage</option>
          </select>
        </div>
        <div class="prop-row">
          <span class="prop-label">Qualit√© image</span>
          <input type="range" id="imgQuality" min="0.5" max="1" step="0.05" value="0.92" oninput="document.getElementById('qualVal').textContent=Math.round(this.value*100)+'%'">
          <span class="prop-val" id="qualVal">92%</span>
        </div>
        <div class="prop-row">
          <span class="prop-label">Marges (mm)</span>
          <input type="number" id="pageMargin" value="10" min="0" max="50" style="width:70px">
        </div>
      </div>
    </div>

    <div class="file-panel">
      <div class="file-panel-header">
        <span class="file-panel-title">Fichiers <span class="badge-count" id="fileCount">0</span></span>
        <button class="btn btn-ghost" style="padding:6px 12px;font-size:0.8rem" onclick="clearAll()">Tout effacer</button>
      </div>
      <div class="file-list" id="fileList">
        <div class="empty-state">Aucun fichier ajout√©.<br>D√©posez vos fichiers √† gauche.</div>
      </div>
      <div class="panel-footer">
        <div class="progress-bar" id="progressBar" style="display:none">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <button class="btn btn-primary convert-all-btn" onclick="convertAll()">
          üîÑ Convertir tout en PDF
        </button>
        <button class="btn btn-success convert-all-btn" id="downloadAllBtn" style="display:none" onclick="downloadAll()">
          ‚¨áÔ∏è T√©l√©charger tous les PDF
        </button>
      </div>
    </div>
  </div>
</div>

<!-- EDITOR PAGE -->
<div class="page" id="page-editor">
  <div class="editor-layout">

    <!-- LEFT SIDEBAR: TOOLS -->
    <div class="editor-sidebar">
      <div class="editor-sidebar-section">
        <div class="section-label">Outils</div>
        <div class="tool-grid">
          <button class="tool-btn active" id="tool-select" onclick="setTool('select')">
            <span class="tool-icon">üñ±Ô∏è</span> S√©lection
          </button>
          <button class="tool-btn" id="tool-text" onclick="setTool('text')">
            <span class="tool-icon">T</span> Texte
          </button>
          <button class="tool-btn" id="tool-rect" onclick="setTool('rect')">
            <span class="tool-icon">‚ñ≠</span> Rectangle
          </button>
          <button class="tool-btn" id="tool-circle" onclick="setTool('circle')">
            <span class="tool-icon">‚óã</span> Cercle
          </button>
          <button class="tool-btn" id="tool-line" onclick="setTool('line')">
            <span class="tool-icon">‚ï±</span> Ligne
          </button>
          <button class="tool-btn" id="tool-arrow" onclick="addArrow()">
            <span class="tool-icon">‚Üí</span> Fl√®che
          </button>
          <button class="tool-btn" id="tool-draw" onclick="setTool('draw')">
            <span class="tool-icon">‚úèÔ∏è</span> Dessin libre
          </button>
          <button class="tool-btn" id="tool-erase" onclick="setTool('erase')">
            <span class="tool-icon">‚¨ú</span> Gomme
          </button>
        </div>
      </div>

      <div class="sidebar-scroll">
        <div class="editor-sidebar-section">
          <div class="section-label">Symboles & Emojis</div>
          <div style="display:flex;flex-wrap:wrap;gap:4px">
            <button class="tool-btn" style="padding:6px;font-size:1.1rem;flex:0 0 auto;width:36px" onclick="addSymbol('‚úì')">‚úì</button>
            <button class="tool-btn" style="padding:6px;font-size:1.1rem;flex:0 0 auto;width:36px" onclick="addSymbol('‚úó')">‚úó</button>
            <button class="tool-btn" style="padding:6px;font-size:1.1rem;flex:0 0 auto;width:36px" onclick="addSymbol('‚òÖ')">‚òÖ</button>
            <button class="tool-btn" style="padding:6px;font-size:1.1rem;flex:0 0 auto;width:36px" onclick="addSymbol('‚¨Ü')">‚¨Ü</button>
            <button class="tool-btn" style="padding:6px;font-size:1.1rem;flex:0 0 auto;width:36px" onclick="addSymbol('‚¨á')">‚¨á</button>
            <button class="tool-btn" style="padding:6px;font-size:1.1rem;flex:0 0 auto;width:36px" onclick="addSymbol('!')">!</button>
            <button class="tool-btn" style="padding:6px;font-size:1.1rem;flex:0 0 auto;width:36px" onclick="addSymbol('?')">?</button>
            <button class="tool-btn" style="padding:6px;font-size:1.1rem;flex:0 0 auto;width:36px" onclick="addSymbol('¬©')">¬©</button>
            <button class="tool-btn" style="padding:6px;font-size:1.1rem;flex:0 0 auto;width:36px" onclick="addSymbol('¬Æ')">¬Æ</button>
            <button class="tool-btn" style="padding:6px;font-size:1.1rem;flex:0 0 auto;width:36px" onclick="addSymbol('‚Ñ¢')">‚Ñ¢</button>
            <button class="tool-btn" style="padding:6px;font-size:1.1rem;flex:0 0 auto;width:36px" onclick="addSymbol('üìå')">üìå</button>
            <button class="tool-btn" style="padding:6px;font-size:1.1rem;flex:0 0 auto;width:36px" onclick="addSymbol('üìé')">üìé</button>
          </div>
        </div>

        <div class="editor-sidebar-section">
          <div class="section-label">Couleur de remplissage</div>
          <div class="color-palette" id="fillPalette">
            <div class="color-swatch selected" style="background:#4f7cff" data-color="#4f7cff" onclick="selectFillColor(this)"></div>
            <div class="color-swatch" style="background:#2dd68c" data-color="#2dd68c" onclick="selectFillColor(this)"></div>
            <div class="color-swatch" style="background:#ff4f6a" data-color="#ff4f6a" onclick="selectFillColor(this)"></div>
            <div class="color-swatch" style="background:#ffd166" data-color="#ffd166" onclick="selectFillColor(this)"></div>
            <div class="color-swatch" style="background:#7c4fff" data-color="#7c4fff" onclick="selectFillColor(this)"></div>
            <div class="color-swatch" style="background:#ffffff" data-color="#ffffff" onclick="selectFillColor(this)" style="border:1px solid #444"></div>
            <div class="color-swatch" style="background:#000000" data-color="#000000" onclick="selectFillColor(this)"></div>
            <div class="color-swatch" style="background:transparent;border:1px dashed #666" data-color="transparent" onclick="selectFillColor(this)"></div>
          </div>
          <div class="color-input-row">
            <input type="color" id="fillColorPicker" value="#4f7cff" onchange="setFillColor(this.value)">
            <span style="font-size:0.8rem;color:var(--text2)">Couleur personnalis√©e</span>
          </div>
        </div>

        <div class="editor-sidebar-section">
          <div class="section-label">Couleur du trait</div>
          <div class="color-palette" id="strokePalette">
            <div class="color-swatch selected" style="background:#ffffff" data-color="#ffffff" onclick="selectStrokeColor(this)"></div>
            <div class="color-swatch" style="background:#4f7cff" data-color="#4f7cff" onclick="selectStrokeColor(this)"></div>
            <div class="color-swatch" style="background:#ff4f6a" data-color="#ff4f6a" onclick="selectStrokeColor(this)"></div>
            <div class="color-swatch" style="background:#000000" data-color="#000000" onclick="selectStrokeColor(this)"></div>
            <div class="color-swatch" style="background:transparent;border:1px dashed #666" data-color="transparent" onclick="selectStrokeColor(this)"></div>
          </div>
          <div class="color-input-row">
            <input type="color" id="strokeColorPicker" value="#ffffff" onchange="setStrokeColor(this.value)">
            <span style="font-size:0.8rem;color:var(--text2)">Couleur personnalis√©e</span>
          </div>
        </div>

        <div class="editor-sidebar-section">
          <div class="section-label">√âpaisseur du trait</div>
          <div class="prop-row">
            <span class="prop-label">√âpaisseur</span>
            <input type="range" id="strokeWidth" min="0" max="20" value="2" oninput="updateStrokeWidth(this.value)">
            <span class="prop-val" id="strokeWidthVal">2</span>
          </div>
          <div class="prop-row">
            <span class="prop-label">Opacit√©</span>
            <input type="range" id="objOpacity" min="0" max="1" step="0.05" value="1" oninput="updateOpacity(this.value)">
            <span class="prop-val" id="opacityVal">100%</span>
          </div>
        </div>

        <div class="editor-sidebar-section">
          <div class="section-label">Texte</div>
          <div class="prop-row" style="margin-bottom:8px">
            <span class="prop-label">Police</span>
            <select id="fontFamily" onchange="updateText()" style="width:140px">
              <option>Arial</option>
              <option>Times New Roman</option>
              <option>Courier New</option>
              <option>Georgia</option>
              <option>Verdana</option>
              <option>Helvetica</option>
              <option>Comic Sans MS</option>
              <option>Impact</option>
            </select>
          </div>
          <div class="prop-row">
            <span class="prop-label">Taille</span>
            <input type="range" id="fontSize" min="8" max="120" value="24" oninput="document.getElementById('fontSizeVal').textContent=this.value; updateText()">
            <span class="prop-val" id="fontSizeVal">24</span>
          </div>
          <div class="text-style-row">
            <button class="style-toggle" id="boldBtn" onclick="toggleBold()"><strong>B</strong></button>
            <button class="style-toggle" id="italicBtn" onclick="toggleItalic()"><em>I</em></button>
            <button class="style-toggle" id="underlineBtn" onclick="toggleUnderline()"><u>U</u></button>
          </div>
        </div>

        <div class="editor-sidebar-section">
          <div class="section-label">Page & Document</div>
          <div class="section-label" style="margin-top:6px;margin-bottom:6px">Format</div>
          <div class="page-sizes">
            <div class="size-btn active" onclick="setCanvasSize('a4',this)">A4</div>
            <div class="size-btn" onclick="setCanvasSize('a3',this)">A3</div>
            <div class="size-btn" onclick="setCanvasSize('letter',this)">Letter</div>
            <div class="size-btn" onclick="setCanvasSize('wide',this)">16:9</div>
          </div>
          <div class="editor-upload-zone" onclick="document.getElementById('editorImgInput').click()">
            üñºÔ∏è Importer une image / PDF
          </div>
          <input type="file" id="editorImgInput" style="display:none" accept="image/*,.pdf" onchange="importToEditor(this.files[0])">
        </div>
      </div>
    </div>

    <!-- CANVAS AREA -->
    <div class="editor-canvas-area">
      <div class="editor-toolbar">
        <button class="toolbar-btn" onclick="canvas.undo ? undoAction() : null" title="Annuler">‚Ü© Annuler</button>
        <button class="toolbar-btn" onclick="redoAction()" title="R√©tablir">‚Ü™ R√©tablir</button>
        <div class="toolbar-sep"></div>
        <button class="toolbar-btn" onclick="bringForward()">‚¨Ü Avant</button>
        <button class="toolbar-btn" onclick="sendBackward()">‚¨á Arri√®re</button>
        <div class="toolbar-sep"></div>
        <button class="toolbar-btn" onclick="duplicateSelected()">‚ßâ Dupliquer</button>
        <button class="toolbar-btn" onclick="deleteSelected()" style="color:var(--danger)">üóë Supprimer</button>
        <div class="toolbar-sep"></div>
        <button class="toolbar-btn" onclick="clearCanvas()" style="color:var(--danger)">‚úï Tout effacer</button>
        <div class="toolbar-sep"></div>
        <button class="toolbar-btn" onclick="exportCanvasAsPDF()" style="color:var(--success);font-weight:600">‚¨á Exporter PDF</button>
        <button class="toolbar-btn" onclick="exportCanvasAsPNG()" style="color:var(--accent)">‚¨á Exporter PNG</button>
      </div>
      <div class="canvas-wrapper" id="canvasWrapper">
        <canvas id="fabricCanvas"></canvas>
      </div>
    </div>

    <!-- RIGHT PANEL: PROPERTIES -->
    <div class="props-panel" id="propsPanel">
      <div class="section-label">Propri√©t√©s de l'objet</div>
      <div class="no-selection" id="noSelMsg">S√©lectionnez un objet<br>pour voir ses propri√©t√©s.</div>
      <div id="objProps" style="display:none">
        <div class="prop-row" style="margin-bottom:12px">
          <span class="prop-label">X</span>
          <input type="number" id="propX" style="width:70px" oninput="updateObjPos()">
        </div>
        <div class="prop-row" style="margin-bottom:12px">
          <span class="prop-label">Y</span>
          <input type="number" id="propY" style="width:70px" oninput="updateObjPos()">
        </div>
        <div class="prop-row" style="margin-bottom:12px">
          <span class="prop-label">Largeur</span>
          <input type="number" id="propW" style="width:70px" oninput="updateObjSize()">
        </div>
        <div class="prop-row" style="margin-bottom:12px">
          <span class="prop-label">Hauteur</span>
          <input type="number" id="propH" style="width:70px" oninput="updateObjSize()">
        </div>
        <div class="prop-row" style="margin-bottom:12px">
          <span class="prop-label">Rotation</span>
          <input type="range" id="propRot" min="-180" max="180" value="0" oninput="document.getElementById('propRotVal').textContent=this.value+'¬∞'; updateObjRot()">
          <span class="prop-val" id="propRotVal">0¬∞</span>
        </div>
        <div style="border-top:1px solid var(--border);margin:12px 0;padding-top:12px">
          <div class="section-label" style="margin-bottom:8px">Actions rapides</div>
          <button class="btn btn-ghost" style="width:100%;margin-bottom:6px;justify-content:center" onclick="centerObj('h')">‚Üî Centrer horizontalement</button>
          <button class="btn btn-ghost" style="width:100%;margin-bottom:6px;justify-content:center" onclick="centerObj('v')">‚Üï Centrer verticalement</button>
          <button class="btn btn-danger" style="width:100%;justify-content:center" onclick="deleteSelected()">üóë Supprimer</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ===================== CONVERTER =====================
const fileMap = new Map();
const convertedPDFs = new Map();
let fileIdCounter = 0;

const dropZone = document.getElementById('dropZone');
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });

function handleFiles(files) {
  Array.from(files).forEach(file => {
    const id = fileIdCounter++;
    fileMap.set(id, { file, status: 'ready' });
    renderFileItem(id, file);
  });
  updateCount();
}

function getFileIcon(file) {
  const t = file.type;
  if (t.startsWith('image/')) return { icon: 'üñºÔ∏è', cls: 'img' };
  if (t === 'application/pdf') return { icon: 'üìÑ', cls: 'pdf' };
  if (t.includes('word') || file.name.match(/\.docx?$/i)) return { icon: 'üìù', cls: 'doc' };
  if (t === 'text/plain') return { icon: 'üìÉ', cls: 'doc' };
  if (t === 'text/html') return { icon: 'üåê', cls: 'doc' };
  return { icon: 'üìÅ', cls: 'other' };
}

function formatSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / 1048576).toFixed(1) + ' MB';
}

function renderFileItem(id, file) {
  const list = document.getElementById('fileList');
  const empty = list.querySelector('.empty-state');
  if (empty) empty.remove();

  const { icon, cls } = getFileIcon(file);
  const el = document.createElement('div');
  el.className = 'file-item';
  el.id = `fi-${id}`;
  el.innerHTML = `
    <div class="file-icon ${cls}">${icon}</div>
    <div class="file-info">
      <div class="file-name">${file.name}</div>
      <div class="file-size">${formatSize(file.size)}</div>
    </div>
    <span class="file-status status-ready" id="fs-${id}">Pr√™t</span>
    <button class="file-remove" onclick="removeFile(${id})">‚úï</button>
  `;
  list.appendChild(el);
}

function removeFile(id) {
  fileMap.delete(id);
  convertedPDFs.delete(id);
  const el = document.getElementById(`fi-${id}`);
  if (el) el.remove();
  updateCount();
  const list = document.getElementById('fileList');
  if (list.children.length === 0) list.innerHTML = '<div class="empty-state">Aucun fichier ajout√©.<br>D√©posez vos fichiers √† gauche.</div>';
}

function clearAll() {
  fileMap.clear();
  convertedPDFs.clear();
  document.getElementById('fileList').innerHTML = '<div class="empty-state">Aucun fichier ajout√©.<br>D√©posez vos fichiers √† gauche.</div>';
  updateCount();
  document.getElementById('downloadAllBtn').style.display = 'none';
}

function updateCount() {
  document.getElementById('fileCount').textContent = fileMap.size;
}

async function convertAll() {
  if (fileMap.size === 0) { showNotif('Ajoutez des fichiers √† convertir.', 'error'); return; }
  const ids = [...fileMap.keys()];
  const bar = document.getElementById('progressBar');
  const fill = document.getElementById('progressFill');
  bar.style.display = 'block';
  let done = 0;

  for (const id of ids) {
    const { file } = fileMap.get(id);
    const statusEl = document.getElementById(`fs-${id}`);
    try {
      statusEl.className = 'file-status status-ready';
      statusEl.textContent = '...';
      const pdfBlob = await fileToPDF(file, id);
      convertedPDFs.set(id, { blob: pdfBlob, name: file.name.replace(/\.[^.]+$/, '') + '.pdf' });
      statusEl.className = 'file-status status-done';
      statusEl.textContent = '‚úì Converti';
    } catch (e) {
      statusEl.className = 'file-status status-error';
      statusEl.textContent = '‚úó Erreur';
      console.error(e);
    }
    done++;
    fill.style.width = (done / ids.length * 100) + '%';
  }

  setTimeout(() => { bar.style.display = 'none'; fill.style.width = '0%'; }, 800);
  document.getElementById('downloadAllBtn').style.display = 'flex';
  showNotif(`‚úì ${convertedPDFs.size} fichier(s) convertis !`, 'success');
}

async function fileToPDF(file, id) {
  const { jsPDF } = window.jspdf;
  const fmt = document.getElementById('pageFormat').value;
  const ori = document.getElementById('pageOrient').value;
  const quality = parseFloat(document.getElementById('imgQuality').value);
  const margin = parseInt(document.getElementById('pageMargin').value) || 10;
  const pdf = new jsPDF({ orientation: ori, unit: 'mm', format: fmt });

  const pw = pdf.internal.pageSize.getWidth();
  const ph = pdf.internal.pageSize.getHeight();

  if (file.type.startsWith('image/') || file.name.match(/\.(heic|heif)$/i)) {
    return await imageFileToPDF(file, pdf, pw, ph, margin, quality);
  } else if (file.type === 'application/pdf') {
    return await pdfToPDF(file, pdf, pw, ph, margin, quality);
  } else if (file.type === 'text/plain') {
    return textToPDF(file, pdf, pw, ph, margin);
  } else if (file.type === 'text/html' || file.name.match(/\.html?$/i)) {
    return htmlToPDF(file, pdf, pw, ph, margin);
  } else if (file.name.match(/\.docx?$/i)) {
    // For .doc/.docx we render as text content
    return docToPDF(file, pdf, pw, ph, margin);
  } else {
    // Fallback: treat as text
    return textToPDF(file, pdf, pw, ph, margin);
  }
}

function imageFileToPDF(file, pdf, pw, ph, margin, quality) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        const usableW = pw - margin * 2;
        const usableH = ph - margin * 2;
        let imgW = usableW, imgH = img.height / img.width * usableW;
        if (imgH > usableH) { imgH = usableH; imgW = img.width / img.height * usableH; }
        const x = (pw - imgW) / 2;
        const y = (ph - imgH) / 2;
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        canvas.getContext('2d').drawImage(img, 0, 0);
        const dataUrl = canvas.toDataURL('image/jpeg', quality);
        pdf.addImage(dataUrl, 'JPEG', x, y, imgW, imgH);
        resolve(pdf.output('blob'));
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function pdfToPDF(file, pdf, pw, ph, margin, quality) {
  // Render PDF pages as images
  const arrayBuffer = await file.arrayBuffer();
  const pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  const numPages = pdfDoc.numPages;

  for (let i = 1; i <= numPages; i++) {
    if (i > 1) pdf.addPage();
    const page = await pdfDoc.getPage(i);
    const viewport = page.getViewport({ scale: 2 });
    const canvas = document.createElement('canvas');
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
    const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
    const usableW = pw - margin * 2;
    const usableH = ph - margin * 2;
    let imgW = usableW, imgH = canvas.height / canvas.width * usableW;
    if (imgH > usableH) { imgH = usableH; imgW = canvas.width / canvas.height * usableH; }
    pdf.addImage(dataUrl, 'JPEG', (pw - imgW) / 2, (ph - imgH) / 2, imgW, imgH);
  }
  return pdf.output('blob');
}

async function textToPDF(file, pdf, pw, ph, margin) {
  const text = await file.text();
  pdf.setFontSize(11);
  pdf.setTextColor(40, 40, 40);
  const lines = pdf.splitTextToSize(text, pw - margin * 2);
  const lineHeight = 6;
  let y = margin + 10;
  lines.forEach(line => {
    if (y + lineHeight > ph - margin) { pdf.addPage(); y = margin + 10; }
    pdf.text(line, margin, y);
    y += lineHeight;
  });
  return pdf.output('blob');
}

async function htmlToPDF(file, pdf, pw, ph, margin) {
  const text = await file.text();
  const tmp = document.createElement('div');
  tmp.innerHTML = text;
  const plain = tmp.innerText || tmp.textContent || '';
  pdf.setFontSize(11);
  const lines = pdf.splitTextToSize(plain, pw - margin * 2);
  let y = margin + 10;
  lines.forEach(line => {
    if (y + 6 > ph - margin) { pdf.addPage(); y = margin + 10; }
    pdf.text(line, margin, y);
    y += 6;
  });
  return pdf.output('blob');
}

async function docToPDF(file, pdf, pw, ph, margin) {
  // Read as arrayBuffer and extract text if possible
  const arrayBuffer = await file.arrayBuffer();
  let text = '';
  try {
    // Try to extract readable text from binary
    const uint8 = new Uint8Array(arrayBuffer);
    const decoder = new TextDecoder('utf-8', { fatal: false });
    const raw = decoder.decode(uint8);
    // Extract readable strings
    text = raw.replace(/[^\x20-\x7E\n\r\t\u00C0-\u024F]/g, ' ').replace(/\s{3,}/g, '\n').trim();
    if (text.length < 50) text = 'Ce fichier Word a √©t√© converti.\nPour un rendu parfait, veuillez copier le contenu de votre document.';
  } catch { text = 'Fichier Word converti en PDF.'; }
  pdf.setFontSize(11);
  const lines = pdf.splitTextToSize(text, pw - margin * 2);
  let y = margin + 10;
  lines.forEach(line => {
    if (y + 6 > ph - margin) { pdf.addPage(); y = margin + 10; }
    pdf.text(line, margin, y);
    y += 6;
  });
  return pdf.output('blob');
}

function downloadAll() {
  if (convertedPDFs.size === 0) { showNotif('Rien √† t√©l√©charger.', 'error'); return; }
  convertedPDFs.forEach(({ blob, name }) => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = name;
    a.click();
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  });
}

// ===================== EDITOR =====================
const { jsPDF } = window.jspdf;
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let canvas;
let currentTool = 'select';
let fillColor = '#4f7cff';
let strokeColor = '#ffffff';
let strokeWidth = 2;
let isDrawing = false;
let drawStart = null;
let tempShape = null;
let history = [];
let historyIndex = -1;

function initCanvas() {
  canvas = new fabric.Canvas('fabricCanvas', {
    backgroundColor: '#ffffff',
    selection: true,
    preserveObjectStacking: true,
  });
  setCanvasSize('a4', document.querySelector('.size-btn.active'));

  canvas.on('object:added', saveHistory);
  canvas.on('object:modified', saveHistory);
  canvas.on('object:removed', saveHistory);

  canvas.on('selection:created', updatePropsPanel);
  canvas.on('selection:updated', updatePropsPanel);
  canvas.on('selection:cleared', () => {
    document.getElementById('noSelMsg').style.display = 'block';
    document.getElementById('objProps').style.display = 'none';
  });

  canvas.on('mouse:down', onMouseDown);
  canvas.on('mouse:move', onMouseMove);
  canvas.on('mouse:up', onMouseUp);
}

function setCanvasSize(preset, el) {
  document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
  if (el) el.classList.add('active');
  const sizes = {
    a4: [794, 1123], a3: [1123, 1587], letter: [816, 1056], wide: [1280, 720]
  };
  const [w, h] = sizes[preset] || sizes.a4;
  canvas.setWidth(w);
  canvas.setHeight(h);
  canvas.renderAll();
}

function setTool(tool) {
  currentTool = tool;
  document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById(`tool-${tool}`);
  if (btn) btn.classList.add('active');

  if (tool === 'draw') {
    canvas.isDrawingMode = true;
    canvas.freeDrawingBrush.color = strokeColor;
    canvas.freeDrawingBrush.width = strokeWidth;
  } else {
    canvas.isDrawingMode = false;
  }

  if (tool === 'select') {
    canvas.selection = true;
    canvas.defaultCursor = 'default';
  } else if (tool !== 'draw') {
    canvas.selection = false;
    canvas.defaultCursor = 'crosshair';
  }

  if (tool === 'text') {
    canvas.defaultCursor = 'text';
  }
}

function onMouseDown(opt) {
  if (currentTool === 'select' || currentTool === 'draw') return;
  if (opt.target && currentTool === 'select') return;

  isDrawing = true;
  const ptr = canvas.getPointer(opt.e);
  drawStart = { x: ptr.x, y: ptr.y };

  if (currentTool === 'text') {
    isDrawing = false;
    const text = new fabric.IText('Cliquez pour √©diter', {
      left: ptr.x, top: ptr.y,
      fontFamily: document.getElementById('fontFamily').value,
      fontSize: parseInt(document.getElementById('fontSize').value),
      fill: fillColor,
    });
    canvas.add(text);
    canvas.setActiveObject(text);
    text.enterEditing();
    return;
  }

  if (currentTool === 'erase') {
    isDrawing = false;
    if (opt.target) { canvas.remove(opt.target); }
    return;
  }

  const opts = {
    left: ptr.x, top: ptr.y, width: 0, height: 0,
    fill: fillColor === 'transparent' ? '' : fillColor,
    stroke: strokeColor === 'transparent' ? '' : strokeColor,
    strokeWidth: strokeWidth,
    opacity: parseFloat(document.getElementById('objOpacity').value),
    selectable: false,
  };

  if (currentTool === 'rect') {
    tempShape = new fabric.Rect({ ...opts, rx: 4, ry: 4 });
  } else if (currentTool === 'circle') {
    tempShape = new fabric.Ellipse({ ...opts, rx: 0, ry: 0 });
  } else if (currentTool === 'line') {
    tempShape = new fabric.Line([ptr.x, ptr.y, ptr.x, ptr.y], {
      stroke: strokeColor === 'transparent' ? '#000' : strokeColor,
      strokeWidth: strokeWidth,
      selectable: false,
    });
  }

  if (tempShape) canvas.add(tempShape);
}

function onMouseMove(opt) {
  if (!isDrawing || !tempShape) return;
  const ptr = canvas.getPointer(opt.e);
  const dx = ptr.x - drawStart.x;
  const dy = ptr.y - drawStart.y;

  if (currentTool === 'rect') {
    if (dx < 0) { tempShape.set({ left: ptr.x, width: Math.abs(dx) }); }
    else { tempShape.set({ width: dx }); }
    if (dy < 0) { tempShape.set({ top: ptr.y, height: Math.abs(dy) }); }
    else { tempShape.set({ height: dy }); }
  } else if (currentTool === 'circle') {
    const rx = Math.abs(dx) / 2, ry = Math.abs(dy) / 2;
    tempShape.set({
      left: dx > 0 ? drawStart.x : ptr.x,
      top: dy > 0 ? drawStart.y : ptr.y,
      rx, ry,
    });
  } else if (currentTool === 'line') {
    tempShape.set({ x2: ptr.x, y2: ptr.y });
  }

  canvas.renderAll();
}

function onMouseUp() {
  if (!isDrawing) return;
  isDrawing = false;
  if (tempShape) {
    tempShape.set({ selectable: true });
    canvas.setActiveObject(tempShape);
    tempShape = null;
    setTool('select');
  }
}

function addArrow() {
  const w = canvas.width / 2, h = canvas.height / 2;
  const line = new fabric.Line([w - 80, h, w + 80, h], {
    stroke: strokeColor === 'transparent' ? '#4f7cff' : strokeColor,
    strokeWidth: strokeWidth || 3,
  });
  const arrowHead = new fabric.Triangle({
    width: 16, height: 16,
    fill: strokeColor === 'transparent' ? '#4f7cff' : strokeColor,
    left: w + 72, top: h - 8,
    angle: 90,
  });
  const group = new fabric.Group([line, arrowHead]);
  canvas.add(group);
  canvas.setActiveObject(group);
  canvas.renderAll();
}

function addSymbol(sym) {
  const text = new fabric.Text(sym, {
    left: canvas.width / 2 - 20,
    top: canvas.height / 2 - 20,
    fontSize: 40,
    fill: fillColor === 'transparent' ? '#4f7cff' : fillColor,
  });
  canvas.add(text);
  canvas.setActiveObject(text);
  canvas.renderAll();
}

function selectFillColor(el) {
  document.querySelectorAll('#fillPalette .color-swatch').forEach(s => s.classList.remove('selected'));
  el.classList.add('selected');
  fillColor = el.dataset.color;
  document.getElementById('fillColorPicker').value = fillColor === 'transparent' ? '#ffffff' : fillColor;
  applyToSelection('fill', fillColor);
  if (canvas.isDrawingMode) {
    canvas.freeDrawingBrush.color = fillColor;
  }
}

function setFillColor(val) {
  fillColor = val;
  applyToSelection('fill', val);
}

function selectStrokeColor(el) {
  document.querySelectorAll('#strokePalette .color-swatch').forEach(s => s.classList.remove('selected'));
  el.classList.add('selected');
  strokeColor = el.dataset.color;
  applyToSelection('stroke', strokeColor);
  canvas.freeDrawingBrush.color = strokeColor;
}

function setStrokeColor(val) {
  strokeColor = val;
  applyToSelection('stroke', val);
}

function updateStrokeWidth(val) {
  strokeWidth = parseInt(val);
  document.getElementById('strokeWidthVal').textContent = val;
  applyToSelection('strokeWidth', strokeWidth);
  canvas.freeDrawingBrush.width = strokeWidth;
}

function updateOpacity(val) {
  document.getElementById('opacityVal').textContent = Math.round(val * 100) + '%';
  applyToSelection('opacity', parseFloat(val));
}

function applyToSelection(prop, val) {
  const obj = canvas.getActiveObject();
  if (!obj) return;
  if (obj.type === 'activeSelection') {
    obj.getObjects().forEach(o => o.set(prop, val));
  } else {
    obj.set(prop, val);
  }
  canvas.renderAll();
}

function updateText() {
  const obj = canvas.getActiveObject();
  if (!obj || (obj.type !== 'i-text' && obj.type !== 'text')) return;
  obj.set({
    fontFamily: document.getElementById('fontFamily').value,
    fontSize: parseInt(document.getElementById('fontSize').value),
  });
  canvas.renderAll();
}

function toggleBold() {
  const obj = canvas.getActiveObject();
  if (!obj) return;
  const isBold = obj.fontWeight === 'bold';
  obj.set('fontWeight', isBold ? 'normal' : 'bold');
  document.getElementById('boldBtn').classList.toggle('on', !isBold);
  canvas.renderAll();
}

function toggleItalic() {
  const obj = canvas.getActiveObject();
  if (!obj) return;
  const isItalic = obj.fontStyle === 'italic';
  obj.set('fontStyle', isItalic ? 'normal' : 'italic');
  document.getElementById('italicBtn').classList.toggle('on', !isItalic);
  canvas.renderAll();
}

function toggleUnderline() {
  const obj = canvas.getActiveObject();
  if (!obj) return;
  obj.set('underline', !obj.underline);
  document.getElementById('underlineBtn').classList.toggle('on', obj.underline);
  canvas.renderAll();
}

function bringForward() {
  const obj = canvas.getActiveObject();
  if (obj) { canvas.bringForward(obj); canvas.renderAll(); }
}

function sendBackward() {
  const obj = canvas.getActiveObject();
  if (obj) { canvas.sendBackwards(obj); canvas.renderAll(); }
}

function duplicateSelected() {
  const obj = canvas.getActiveObject();
  if (!obj) return;
  obj.clone(cloned => {
    cloned.set({ left: obj.left + 20, top: obj.top + 20 });
    canvas.add(cloned);
    canvas.setActiveObject(cloned);
    canvas.renderAll();
  });
}

function deleteSelected() {
  const obj = canvas.getActiveObject();
  if (!obj) return;
  if (obj.type === 'activeSelection') {
    obj.getObjects().forEach(o => canvas.remove(o));
    canvas.discardActiveObject();
  } else {
    canvas.remove(obj);
  }
  canvas.renderAll();
}

function clearCanvas() {
  if (!confirm('Effacer tout le contenu du canvas ?')) return;
  canvas.clear();
  canvas.backgroundColor = '#ffffff';
  canvas.renderAll();
}

function centerObj(axis) {
  const obj = canvas.getActiveObject();
  if (!obj) return;
  if (axis === 'h') obj.set('left', (canvas.width - obj.getScaledWidth()) / 2);
  if (axis === 'v') obj.set('top', (canvas.height - obj.getScaledHeight()) / 2);
  obj.setCoords();
  canvas.renderAll();
}

function updatePropsPanel() {
  const obj = canvas.getActiveObject();
  if (!obj) return;
  document.getElementById('noSelMsg').style.display = 'none';
  document.getElementById('objProps').style.display = 'block';
  document.getElementById('propX').value = Math.round(obj.left);
  document.getElementById('propY').value = Math.round(obj.top);
  document.getElementById('propW').value = Math.round(obj.getScaledWidth());
  document.getElementById('propH').value = Math.round(obj.getScaledHeight());
  document.getElementById('propRot').value = Math.round(obj.angle);
  document.getElementById('propRotVal').textContent = Math.round(obj.angle) + '¬∞';
}

function updateObjPos() {
  const obj = canvas.getActiveObject();
  if (!obj) return;
  obj.set({ left: parseInt(document.getElementById('propX').value), top: parseInt(document.getElementById('propY').value) });
  obj.setCoords();
  canvas.renderAll();
}

function updateObjSize() {
  const obj = canvas.getActiveObject();
  if (!obj) return;
  const scaleX = parseInt(document.getElementById('propW').value) / obj.width;
  const scaleY = parseInt(document.getElementById('propH').value) / obj.height;
  obj.set({ scaleX, scaleY });
  obj.setCoords();
  canvas.renderAll();
}

function updateObjRot() {
  const obj = canvas.getActiveObject();
  if (!obj) return;
  obj.set('angle', parseInt(document.getElementById('propRot').value));
  obj.setCoords();
  canvas.renderAll();
}

function saveHistory() {
  const json = JSON.stringify(canvas.toJSON());
  history = history.slice(0, historyIndex + 1);
  history.push(json);
  historyIndex = history.length - 1;
}

function undoAction() {
  if (historyIndex <= 0) return;
  historyIndex--;
  canvas.loadFromJSON(history[historyIndex], () => canvas.renderAll());
}

function redoAction() {
  if (historyIndex >= history.length - 1) return;
  historyIndex++;
  canvas.loadFromJSON(history[historyIndex], () => canvas.renderAll());
}

async function importToEditor(file) {
  if (!file) return;
  if (file.type.startsWith('image/')) {
    const reader = new FileReader();
    reader.onload = e => {
      fabric.Image.fromURL(e.target.result, img => {
        const maxW = canvas.width * 0.9;
        if (img.width > maxW) { const s = maxW / img.width; img.scaleX = s; img.scaleY = s; }
        img.set({ left: 20, top: 20 });
        canvas.add(img);
        canvas.setActiveObject(img);
        canvas.renderAll();
      });
    };
    reader.readAsDataURL(file);
  } else if (file.type === 'application/pdf') {
    const ab = await file.arrayBuffer();
    const pdfDoc = await pdfjsLib.getDocument({ data: ab }).promise;
    const page = await pdfDoc.getPage(1);
    const vp = page.getViewport({ scale: 1.5 });
    const cvs = document.createElement('canvas');
    cvs.width = vp.width; cvs.height = vp.height;
    await page.render({ canvasContext: cvs.getContext('2d'), viewport: vp }).promise;
    fabric.Image.fromURL(cvs.toDataURL(), img => {
      const maxW = canvas.width * 0.95;
      if (img.width > maxW) { const s = maxW / img.width; img.scaleX = s; img.scaleY = s; }
      img.set({ left: 10, top: 10, selectable: true });
      canvas.add(img);
      canvas.sendToBack(img);
      canvas.renderAll();
    });
    showNotif('PDF import√© (page 1). Vous pouvez maintenant l\'annoter.', 'success');
  }
}

async function exportCanvasAsPDF() {
  const { jsPDF } = window.jspdf;
  const w = canvas.width, h = canvas.height;
  const dataUrl = canvas.toDataURL({ format: 'jpeg', quality: 0.95 });
  const pdf = new jsPDF({ orientation: w > h ? 'landscape' : 'portrait', unit: 'px', format: [w, h] });
  pdf.addImage(dataUrl, 'JPEG', 0, 0, w, h);
  pdf.save('document-editeur.pdf');
  showNotif('PDF export√© avec succ√®s !', 'success');
}

function exportCanvasAsPNG() {
  const dataUrl = canvas.toDataURL({ format: 'png', multiplier: 2 });
  const a = document.createElement('a');
  a.href = dataUrl;
  a.download = 'document-editeur.png';
  a.click();
  showNotif('PNG export√© !', 'success');
}

// ===================== SHARED =====================
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(`page-${id}`).classList.add('active');
  const tabs = document.querySelectorAll('.tab');
  if (id === 'converter') tabs[0].classList.add('active');
  else tabs[1].classList.add('active');
}

let notifTimer;
function showNotif(msg, type = 'info') {
  const existing = document.querySelector('.notif');
  if (existing) existing.remove();
  clearTimeout(notifTimer);
  const el = document.createElement('div');
  el.className = `notif ${type}`;
  el.innerHTML = `<span>${msg}</span>`;
  document.body.appendChild(el);
  notifTimer = setTimeout(() => el.remove(), 3500);
}

// INIT
window.addEventListener('load', () => {
  initCanvas();
});
</script>
</body>
</html>
