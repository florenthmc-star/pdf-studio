<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PDF Studio</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Outfit:wght@300;400;500;600&display=swap');

:root {
  --bg: #f0f4ff;
  --white: #ffffff;
  --card: #ffffff;
  --border: #e2e8f8;
  --blue: #4361ee;
  --blue2: #3a86ff;
  --purple: #7b5ea7;
  --green: #2ec4b6;
  --orange: #ff9f1c;
  --red: #e63946;
  --text: #1a1d2e;
  --text2: #6b7194;
  --shadow: 0 4px 24px rgba(67,97,238,0.10);
  --shadow-hover: 0 8px 32px rgba(67,97,238,0.18);
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: var(--bg);
  font-family: 'Outfit', sans-serif;
  color: var(--text);
  min-height: 100vh;
  background-image: radial-gradient(circle at 20% 20%, rgba(67,97,238,0.06) 0%, transparent 50%),
                    radial-gradient(circle at 80% 80%, rgba(123,94,167,0.06) 0%, transparent 50%);
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header {
  background: var(--white);
  border-bottom: 1px solid var(--border);
  padding: 0 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 68px;
  position: sticky;
  top: 0;
  z-index: 200;
  box-shadow: 0 2px 12px rgba(67,97,238,0.06);
}

.logo {
  font-family: 'Nunito', sans-serif;
  font-weight: 900;
  font-size: 1.5rem;
  display: flex;
  align-items: center;
  gap: 10px;
}
.logo-icon {
  width: 38px; height: 38px;
  background: linear-gradient(135deg, var(--blue), var(--purple));
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.2rem;
  box-shadow: 0 4px 12px rgba(67,97,238,0.3);
}
.logo-text { background: linear-gradient(135deg, var(--blue), var(--purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

/* NAV TABS */
.nav {
  display: flex;
  gap: 6px;
  background: var(--bg);
  padding: 5px;
  border-radius: 14px;
  border: 1px solid var(--border);
}
.nav-tab {
  padding: 8px 20px;
  border: none;
  background: transparent;
  border-radius: 10px;
  font-family: 'Outfit', sans-serif;
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--text2);
  cursor: pointer;
  transition: all 0.25s;
  display: flex; align-items: center; gap: 7px;
}
.nav-tab.active {
  background: var(--white);
  color: var(--blue);
  box-shadow: 0 2px 10px rgba(67,97,238,0.12);
}
.nav-tab:hover:not(.active) { color: var(--text); }

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.page { display: none; padding: 32px; max-width: 1100px; margin: 0 auto; }
.page.active { display: block; }

/* ‚îÄ‚îÄ SECTION TITLE ‚îÄ‚îÄ */
.section-title {
  font-family: 'Nunito', sans-serif;
  font-weight: 800;
  font-size: 1.6rem;
  color: var(--text);
  margin-bottom: 6px;
}
.section-sub { color: var(--text2); font-size: 0.95rem; margin-bottom: 28px; }

/* ‚îÄ‚îÄ DROP ZONE ‚îÄ‚îÄ */
.dropzone {
  border: 3px dashed var(--border);
  border-radius: 24px;
  padding: 52px 32px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
  background: var(--white);
  position: relative;
  overflow: hidden;
  margin-bottom: 28px;
}
.dropzone::before {
  content: '';
  position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(67,97,238,0.04), rgba(123,94,167,0.04));
  opacity: 0; transition: opacity 0.3s;
}
.dropzone.over, .dropzone:hover { border-color: var(--blue); }
.dropzone.over::before, .dropzone:hover::before { opacity: 1; }
.dropzone.over { background: #f5f7ff; transform: scale(1.005); }

.dz-emoji {
  font-size: 3.5rem;
  display: block;
  margin-bottom: 14px;
  animation: bounce 2.5s ease-in-out infinite;
}
@keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }

.dz-title {
  font-family: 'Nunito', sans-serif;
  font-weight: 800;
  font-size: 1.25rem;
  margin-bottom: 6px;
  color: var(--text);
}
.dz-sub { color: var(--text2); font-size: 0.88rem; margin-bottom: 20px; line-height: 1.6; }

.format-pills {
  display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin-bottom: 22px;
}
.pill {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.76rem;
  font-weight: 700;
  letter-spacing: 0.3px;
}
.pill-img { background: #e8f4fd; color: #2196f3; }
.pill-doc { background: #e8f0fe; color: #4361ee; }
.pill-pdf { background: #fde8e8; color: #e63946; }
.pill-txt { background: #e8fdf5; color: #2ec4b6; }

.btn {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 11px 26px;
  border: none; border-radius: 12px;
  font-family: 'Outfit', sans-serif;
  font-weight: 600; font-size: 0.92rem;
  cursor: pointer; transition: all 0.2s;
}
.btn-blue { background: var(--blue); color: #fff; box-shadow: 0 4px 14px rgba(67,97,238,0.35); }
.btn-blue:hover { background: #3451d1; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(67,97,238,0.4); }
.btn-green { background: var(--green); color: #fff; box-shadow: 0 4px 14px rgba(46,196,182,0.35); }
.btn-green:hover { background: #25a99f; transform: translateY(-2px); }
.btn-orange { background: var(--orange); color: #fff; box-shadow: 0 4px 14px rgba(255,159,28,0.35); }
.btn-orange:hover { background: #e88e10; transform: translateY(-2px); }
.btn-ghost { background: var(--white); color: var(--text2); border: 1.5px solid var(--border); }
.btn-ghost:hover { border-color: var(--blue); color: var(--blue); background: #f5f7ff; }
.btn-red { background: #fde8e8; color: var(--red); border: 1.5px solid #fac5c8; }
.btn-red:hover { background: #fac5c8; }
.btn-sm { padding: 7px 14px; font-size: 0.82rem; border-radius: 9px; }

/* ‚îÄ‚îÄ FILE CARDS ‚îÄ‚îÄ */
.files-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 14px;
}
.files-label {
  font-family: 'Nunito', sans-serif;
  font-weight: 800; font-size: 1rem; color: var(--text);
  display: flex; align-items: center; gap: 8px;
}
.count-badge {
  background: var(--blue); color: white;
  border-radius: 20px; padding: 2px 10px;
  font-size: 0.78rem; font-weight: 700;
}
.hint-text {
  font-size: 0.8rem; color: var(--text2);
  display: flex; align-items: center; gap: 5px;
}

#fileCards {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 24px;
  min-height: 20px;
}

.file-card {
  background: var(--white);
  border: 2px solid var(--border);
  border-radius: 16px;
  padding: 14px 16px;
  display: flex; align-items: center; gap: 14px;
  transition: all 0.2s;
  cursor: grab;
  user-select: none;
  position: relative;
}
.file-card:hover { border-color: var(--blue); box-shadow: var(--shadow-hover); transform: translateY(-1px); }
.file-card.dragging { opacity: 0.45; transform: scale(0.98); border-style: dashed; }
.file-card.drag-over { border-color: var(--blue); border-style: solid; background: #f5f7ff; transform: scale(1.01); }

.file-card-num {
  width: 28px; height: 28px;
  background: linear-gradient(135deg, var(--blue), var(--purple));
  color: white;
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-weight: 800; font-size: 0.82rem;
  flex-shrink: 0;
  font-family: 'Nunito', sans-serif;
}

.file-thumb {
  width: 44px; height: 52px;
  border-radius: 8px;
  overflow: hidden;
  flex-shrink: 0;
  border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  background: var(--bg);
  font-size: 1.6rem;
  position: relative;
}
.file-thumb img { width: 100%; height: 100%; object-fit: cover; }
.file-thumb canvas { width: 100% !important; height: 100% !important; object-fit: cover; }

.file-card-info { flex: 1; min-width: 0; }
.file-card-name {
  font-weight: 700; font-size: 0.9rem;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  margin-bottom: 3px;
}
.file-card-meta { font-size: 0.78rem; color: var(--text2); display: flex; gap: 10px; }

.file-card-status {
  padding: 4px 10px; border-radius: 20px;
  font-size: 0.75rem; font-weight: 700;
  flex-shrink: 0;
}
.st-ready { background: #e8f0fe; color: var(--blue); }
.st-converting { background: #fff8e8; color: var(--orange); }
.st-done { background: #e8fdf5; color: var(--green); }
.st-error { background: #fde8e8; color: var(--red); }

.drag-handle {
  color: #c0c8e0; font-size: 1.2rem;
  cursor: grab; flex-shrink: 0; padding: 0 4px;
  line-height: 1;
}
.drag-handle:active { cursor: grabbing; }

.card-remove {
  background: none; border: none;
  color: #c0c8e0; font-size: 1.1rem;
  cursor: pointer; padding: 4px 6px;
  border-radius: 6px; transition: all 0.15s;
  flex-shrink: 0;
}
.card-remove:hover { background: #fde8e8; color: var(--red); }

/* ‚îÄ‚îÄ ACTIONS BAR ‚îÄ‚îÄ */
.actions-bar {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 20px 24px;
  display: flex; align-items: center; gap: 12px;
  flex-wrap: wrap;
  box-shadow: var(--shadow);
}
.actions-bar-sep { flex: 1; }

/* Options panel */
.options-row {
  display: flex; gap: 14px; flex-wrap: wrap; margin-bottom: 18px;
}
.opt-card {
  background: var(--white);
  border: 1.5px solid var(--border);
  border-radius: 14px;
  padding: 14px 18px;
  flex: 1; min-width: 140px;
}
.opt-label { font-size: 0.75rem; font-weight: 700; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }

select, input[type="number"] {
  background: var(--bg);
  border: 1.5px solid var(--border);
  color: var(--text);
  padding: 7px 12px;
  border-radius: 9px;
  font-family: 'Outfit', sans-serif;
  font-size: 0.85rem;
  width: 100%;
  cursor: pointer;
  transition: border-color 0.2s;
}
select:focus, input:focus { outline: none; border-color: var(--blue); }

/* Toggle switch */
.toggle-row { display: flex; align-items: center; gap: 10px; margin-top: 4px; }
.toggle {
  width: 42px; height: 24px;
  background: var(--border); border-radius: 12px;
  position: relative; cursor: pointer; transition: background 0.2s;
  border: none; flex-shrink: 0;
}
.toggle.on { background: var(--blue); }
.toggle::after {
  content: ''; position: absolute;
  width: 18px; height: 18px;
  background: white; border-radius: 50%;
  top: 3px; left: 3px;
  transition: left 0.2s;
  box-shadow: 0 1px 4px rgba(0,0,0,0.15);
}
.toggle.on::after { left: 21px; }
.toggle-label { font-size: 0.85rem; font-weight: 600; color: var(--text); }

/* Progress */
.progress-wrap {
  background: var(--white);
  border-radius: 20px;
  padding: 24px;
  border: 1px solid var(--border);
  display: none;
  margin-bottom: 16px;
}
.progress-wrap.show { display: block; }
.progress-label { font-weight: 700; font-size: 0.9rem; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.progress-bar { height: 10px; background: var(--bg); border-radius: 5px; overflow: hidden; }
.progress-fill { height: 100%; background: linear-gradient(90deg, var(--blue), var(--purple)); border-radius: 5px; transition: width 0.35s ease; width: 0%; }
.progress-step { font-size: 0.8rem; color: var(--text2); margin-top: 8px; }

/* Empty state */
.empty-state {
  text-align: center; padding: 32px; color: var(--text2); font-size: 0.9rem;
  border: 2px dashed var(--border); border-radius: 16px;
  background: rgba(255,255,255,0.5);
}
.empty-state-icon { font-size: 2.5rem; margin-bottom: 10px; display: block; }

/* ‚îÄ‚îÄ SUCCESS MODAL ‚îÄ‚îÄ */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.4);
  backdrop-filter: blur(6px);
  display: none; align-items: center; justify-content: center;
  z-index: 9999;
}
.modal-overlay.show { display: flex; }
.modal {
  background: var(--white);
  border-radius: 24px;
  padding: 40px;
  text-align: center;
  max-width: 400px; width: 90%;
  box-shadow: 0 20px 60px rgba(0,0,0,0.15);
  animation: popIn 0.35s cubic-bezier(.175,.885,.32,1.275);
}
@keyframes popIn { from{opacity:0;transform:scale(0.85)} to{opacity:1;transform:scale(1)} }
.modal-icon { font-size: 4rem; margin-bottom: 16px; display: block; }
.modal-title { font-family: 'Nunito', sans-serif; font-weight: 900; font-size: 1.5rem; margin-bottom: 8px; }
.modal-sub { color: var(--text2); font-size: 0.9rem; margin-bottom: 28px; line-height: 1.6; }
.modal-btns { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }

/* ‚îÄ‚îÄ EDITOR PAGE ‚îÄ‚îÄ */
.editor-wrap {
  display: grid;
  grid-template-columns: 220px 1fr 200px;
  gap: 0;
  height: calc(100vh - 68px);
  margin: -32px;
  overflow: hidden;
}

.ed-sidebar {
  background: var(--white);
  border-right: 1px solid var(--border);
  overflow-y: auto;
  display: flex; flex-direction: column;
}
.ed-sidebar::-webkit-scrollbar { width: 4px; }
.ed-sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.sidebar-section {
  padding: 14px;
  border-bottom: 1px solid var(--border);
}
.ss-label {
  font-size: 0.7rem; font-weight: 800;
  text-transform: uppercase; letter-spacing: 1px;
  color: var(--text2); margin-bottom: 10px;
}

.tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }

.t-btn {
  padding: 9px 6px;
  background: var(--bg);
  border: 1.5px solid var(--border);
  border-radius: 10px;
  color: var(--text2);
  font-family: 'Outfit', sans-serif;
  font-size: 0.78rem; font-weight: 600;
  cursor: pointer; transition: all 0.2s;
  text-align: center;
  display: flex; flex-direction: column; align-items: center; gap: 3px;
}
.t-btn .ti { font-size: 1.15rem; }
.t-btn:hover, .t-btn.active {
  background: #eef1ff;
  border-color: var(--blue);
  color: var(--blue);
}

.sym-grid { display: flex; flex-wrap: wrap; gap: 4px; }
.sym-btn {
  width: 34px; height: 34px;
  background: var(--bg); border: 1.5px solid var(--border);
  border-radius: 8px; cursor: pointer; font-size: 1rem;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
.sym-btn:hover { background: #eef1ff; border-color: var(--blue); }

/* color swatches */
.swatch-row { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 8px; }
.swatch {
  width: 22px; height: 22px; border-radius: 6px;
  cursor: pointer; border: 2px solid transparent; transition: all 0.15s;
}
.swatch.sel { border-color: var(--text); transform: scale(1.2); }
.swatch-transparent {
  background: linear-gradient(45deg, #ccc 25%, white 25%, white 75%, #ccc 75%);
  background-size: 10px 10px;
}

.prop-row2 {
  display: flex; align-items: center; gap: 8px; margin-bottom: 7px;
}
.pr-label { font-size: 0.78rem; color: var(--text2); flex-shrink: 0; width: 56px; }
input[type="range"] {
  flex: 1; accent-color: var(--blue); height: 4px; cursor: pointer;
}
.pr-val { font-size: 0.78rem; min-width: 30px; text-align: right; font-weight: 600; }

input[type="color"] {
  width: 32px; height: 32px;
  border: 1.5px solid var(--border); border-radius: 8px;
  padding: 2px; background: none; cursor: pointer;
}

.font-select {
  background: var(--bg);
  border: 1.5px solid var(--border);
  color: var(--text);
  padding: 6px 10px;
  border-radius: 9px;
  font-family: 'Outfit', sans-serif;
  font-size: 0.82rem;
  width: 100%;
  margin-bottom: 7px;
}

.style-btns { display: flex; gap: 4px; margin-bottom: 7px; }
.st-btn {
  flex: 1; padding: 6px;
  background: var(--bg); border: 1.5px solid var(--border);
  border-radius: 8px; cursor: pointer; font-size: 0.85rem;
  text-align: center; transition: all 0.15s; font-family: serif;
}
.st-btn:hover, .st-btn.on { background: #eef1ff; border-color: var(--blue); color: var(--blue); }

/* Canvas zone */
.ed-canvas-zone {
  display: flex; flex-direction: column;
  background: #e8ecf5;
  overflow: hidden;
}
.ed-toolbar {
  background: var(--white);
  border-bottom: 1px solid var(--border);
  padding: 8px 14px;
  display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
}
.tb-btn {
  padding: 6px 12px; border: 1.5px solid var(--border);
  background: var(--bg); border-radius: 8px;
  font-family: 'Outfit', sans-serif; font-size: 0.8rem; font-weight: 600;
  color: var(--text2); cursor: pointer; transition: all 0.15s;
  display: flex; align-items: center; gap: 5px;
}
.tb-btn:hover { border-color: var(--blue); color: var(--blue); background: #eef1ff; }
.tb-sep { width: 1px; height: 22px; background: var(--border); margin: 0 2px; }
.tb-btn.tb-export { background: var(--blue); color: white; border-color: var(--blue); }
.tb-btn.tb-export:hover { background: #3451d1; }

.canvas-scroll {
  flex: 1; overflow: auto;
  display: flex; align-items: flex-start; justify-content: center;
  padding: 28px;
}
.canvas-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
.canvas-scroll::-webkit-scrollbar-thumb { background: #c0c8e0; border-radius: 4px; }

/* Properties panel */
.ed-props {
  background: var(--white);
  border-left: 1px solid var(--border);
  overflow-y: auto;
  padding: 14px;
}
.ed-props::-webkit-scrollbar { width: 4px; }
.ed-props::-webkit-scrollbar-thumb { background: var(--border); }

.no-sel {
  text-align: center; padding: 24px 12px;
  color: var(--text2); font-size: 0.82rem; line-height: 1.6;
}
.no-sel-icon { font-size: 2rem; margin-bottom: 8px; display: block; }

.prop-input {
  background: var(--bg); border: 1.5px solid var(--border);
  color: var(--text); padding: 6px 10px;
  border-radius: 9px; font-family: 'Outfit', sans-serif;
  font-size: 0.82rem; width: 70px;
}
.prop-action {
  width: 100%; padding: 8px; background: var(--bg);
  border: 1.5px solid var(--border); border-radius: 9px;
  font-family: 'Outfit', sans-serif; font-size: 0.8rem; font-weight: 600;
  color: var(--text2); cursor: pointer; transition: all 0.15s;
  margin-bottom: 5px; text-align: center;
}
.prop-action:hover { border-color: var(--blue); color: var(--blue); background: #eef1ff; }
.prop-del { border-color: #fac5c8; color: var(--red); background: #fde8e8; }
.prop-del:hover { background: #fac5c8; }

/* Notification */
.toast {
  position: fixed; bottom: 24px; right: 24px;
  background: var(--text); color: white;
  border-radius: 14px; padding: 14px 20px;
  font-size: 0.88rem; font-weight: 600;
  z-index: 99999;
  display: flex; align-items: center; gap: 10px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.15);
  animation: toastIn 0.3s ease;
  max-width: 320px;
}
.toast.green { background: var(--green); }
.toast.red { background: var(--red); }
@keyframes toastIn { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }

/* import zone in editor */
.import-zone {
  border: 2px dashed var(--border);
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 0.8rem;
  color: var(--text2);
  font-weight: 600;
  margin: 8px 0;
}
.import-zone:hover { border-color: var(--blue); color: var(--blue); background: #eef1ff; }

.page-preset-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
.pp-btn {
  padding: 7px; background: var(--bg); border: 1.5px solid var(--border);
  border-radius: 8px; font-size: 0.78rem; font-weight: 700; color: var(--text2);
  cursor: pointer; text-align: center; transition: all 0.15s;
}
.pp-btn:hover, .pp-btn.active { border-color: var(--blue); color: var(--blue); background: #eef1ff; }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">
    <div class="logo-icon">üìÑ</div>
    <span class="logo-text">PDF Studio</span>
  </div>
  <nav class="nav">
    <button class="nav-tab active" onclick="goPage('convert')">üìÇ Convertir & Fusionner</button>
    <button class="nav-tab" onclick="goPage('editor')">‚úèÔ∏è √âditeur</button>
  </nav>
  <div style="width:180px"></div>
</header>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE CONVERTER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page active" id="page-convert">

  <div class="section-title">üìÇ Vos fichiers ‚Üí PDF</div>
  <p class="section-sub">Glissez vos fichiers, r√©organisez-les dans l'ordre voulu, puis convertissez ou fusionnez en un seul PDF.</p>

  <!-- DROP ZONE -->
  <div class="dropzone" id="dropzone" onclick="document.getElementById('fileIn').click()">
    <span class="dz-emoji">üì•</span>
    <div class="dz-title">D√©posez vos fichiers ici</div>
    <div class="dz-sub">Ou cliquez pour parcourir vos fichiers sur votre ordinateur</div>
    <div class="format-pills">
      <span class="pill pill-img">JPG</span>
      <span class="pill pill-img">PNG</span>
      <span class="pill pill-img">WebP</span>
      <span class="pill pill-img">HEIC</span>
      <span class="pill pill-img">GIF</span>
      <span class="pill pill-doc">DOC/DOCX</span>
      <span class="pill pill-pdf">PDF</span>
      <span class="pill pill-txt">TXT</span>
      <span class="pill pill-txt">HTML</span>
    </div>
    <button class="btn btn-blue" onclick="event.stopPropagation(); document.getElementById('fileIn').click()">
      Ôºã Choisir des fichiers
    </button>
    <input type="file" id="fileIn" multiple style="display:none" accept="image/*,.pdf,.doc,.docx,.txt,.html,.htm" onchange="addFiles(this.files)">
  </div>

  <!-- OPTIONS -->
  <div class="options-row">
    <div class="opt-card">
      <div class="opt-label">üìÑ Format de page</div>
      <select id="optFmt">
        <option value="a4">A4 (210√ó297mm)</option>
        <option value="a3">A3 (297√ó420mm)</option>
        <option value="letter">Letter (US)</option>
        <option value="legal">Legal (US)</option>
      </select>
    </div>
    <div class="opt-card">
      <div class="opt-label">‚ÜîÔ∏è Orientation</div>
      <select id="optOri">
        <option value="portrait">Portrait</option>
        <option value="landscape">Paysage</option>
      </select>
    </div>
    <div class="opt-card">
      <div class="opt-label">üî≤ Marges (mm)</div>
      <input type="number" id="optMargin" value="10" min="0" max="50" style="width:100%">
    </div>
    <div class="opt-card">
      <div class="opt-label">üì¶ Fusion en 1 PDF</div>
      <div class="toggle-row">
        <button class="toggle on" id="mergeToggle" onclick="toggleMerge()"></button>
        <span class="toggle-label" id="mergeLabel">Activ√©e</span>
      </div>
    </div>
  </div>

  <!-- FILE LIST -->
  <div class="files-header">
    <div class="files-label">
      Fichiers
      <span class="count-badge" id="countBadge">0</span>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <span class="hint-text">‚†ø Glissez les cartes pour changer l'ordre</span>
      <button class="btn btn-ghost btn-sm" onclick="clearAll()">Tout effacer</button>
    </div>
  </div>

  <div id="fileCards">
    <div class="empty-state" id="emptyState">
      <span class="empty-state-icon">üìã</span>
      Aucun fichier ajout√©.<br>Glissez des fichiers ou cliquez sur la zone ci-dessus.
    </div>
  </div>

  <!-- PROGRESS -->
  <div class="progress-wrap" id="progressWrap">
    <div class="progress-label">‚öôÔ∏è <span id="progressLabel">Conversion en cours...</span></div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    <div class="progress-step" id="progressStep"></div>
  </div>

  <!-- ACTIONS -->
  <div class="actions-bar">
    <button class="btn btn-blue" onclick="runConvert()" id="convertBtn">
      üîÑ Convertir en PDF
    </button>
    <button class="btn btn-green" onclick="downloadAll()" id="dlBtn" style="display:none">
      ‚¨áÔ∏è T√©l√©charger
    </button>
    <div class="actions-bar-sep"></div>
    <button class="btn btn-ghost btn-sm" onclick="document.getElementById('fileIn').click()">Ôºã Ajouter des fichiers</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE EDITOR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-editor">
  <div class="editor-wrap">

    <!-- LEFT: tools -->
    <div class="ed-sidebar">

      <div class="sidebar-section">
        <div class="ss-label">Outils</div>
        <div class="tools-grid">
          <button class="t-btn active" id="tb-select" onclick="setTool('select')"><span class="ti">üñ±Ô∏è</span>S√©lection</button>
          <button class="t-btn" id="tb-text" onclick="setTool('text')"><span class="ti" style="font-weight:900;font-size:1.3rem">T</span>Texte</button>
          <button class="t-btn" id="tb-rect" onclick="setTool('rect')"><span class="ti">‚ñ≠</span>Rectangle</button>
          <button class="t-btn" id="tb-circle" onclick="setTool('circle')"><span class="ti">‚óã</span>Cercle</button>
          <button class="t-btn" id="tb-line" onclick="setTool('line')"><span class="ti">‚ï±</span>Ligne</button>
          <button class="t-btn" id="tb-arrow" onclick="addArrow()"><span class="ti">‚ûú</span>Fl√®che</button>
          <button class="t-btn" id="tb-draw" onclick="setTool('draw')"><span class="ti">‚úèÔ∏è</span>Dessin libre</button>
          <button class="t-btn" id="tb-erase" onclick="setTool('erase')"><span class="ti">üßπ</span>Gomme</button>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="ss-label">Symboles</div>
        <div class="sym-grid">
          <button class="sym-btn" onclick="addSym('‚úì')">‚úì</button>
          <button class="sym-btn" onclick="addSym('‚úó')">‚úó</button>
          <button class="sym-btn" onclick="addSym('‚òÖ')">‚òÖ</button>
          <button class="sym-btn" onclick="addSym('!')">!</button>
          <button class="sym-btn" onclick="addSym('?')">?</button>
          <button class="sym-btn" onclick="addSym('‚ûú')">‚ûú</button>
          <button class="sym-btn" onclick="addSym('‚¨Ü')">‚¨Ü</button>
          <button class="sym-btn" onclick="addSym('‚¨á')">‚¨á</button>
          <button class="sym-btn" onclick="addSym('¬©')">¬©</button>
          <button class="sym-btn" onclick="addSym('¬Æ')">¬Æ</button>
          <button class="sym-btn" onclick="addSym('‚Ñ¢')">‚Ñ¢</button>
          <button class="sym-btn" onclick="addSym('üìå')">üìå</button>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="ss-label">Couleur de remplissage</div>
        <div class="swatch-row" id="fillSwatches">
          <div class="swatch sel" style="background:#4361ee" data-c="#4361ee" onclick="pickFill(this)"></div>
          <div class="swatch" style="background:#e63946" data-c="#e63946" onclick="pickFill(this)"></div>
          <div class="swatch" style="background:#2ec4b6" data-c="#2ec4b6" onclick="pickFill(this)"></div>
          <div class="swatch" style="background:#ff9f1c" data-c="#ff9f1c" onclick="pickFill(this)"></div>
          <div class="swatch" style="background:#7b5ea7" data-c="#7b5ea7" onclick="pickFill(this)"></div>
          <div class="swatch" style="background:#000000" data-c="#000000" onclick="pickFill(this)"></div>
          <div class="swatch" style="background:#ffffff;border:1.5px solid #ddd" data-c="#ffffff" onclick="pickFill(this)"></div>
          <div class="swatch swatch-transparent" data-c="transparent" onclick="pickFill(this)" title="Transparent"></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="color" id="fillPicker" value="#4361ee" onchange="setFill(this.value)">
          <span style="font-size:0.78rem;color:var(--text2)">Personnalis√©e</span>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="ss-label">Couleur du contour</div>
        <div class="swatch-row" id="strokeSwatches">
          <div class="swatch sel" style="background:#1a1d2e" data-c="#1a1d2e" onclick="pickStroke(this)"></div>
          <div class="swatch" style="background:#4361ee" data-c="#4361ee" onclick="pickStroke(this)"></div>
          <div class="swatch" style="background:#e63946" data-c="#e63946" onclick="pickStroke(this)"></div>
          <div class="swatch" style="background:#ffffff;border:1.5px solid #ddd" data-c="#ffffff" onclick="pickStroke(this)"></div>
          <div class="swatch swatch-transparent" data-c="transparent" onclick="pickStroke(this)" title="Aucun"></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="color" id="strokePicker" value="#1a1d2e" onchange="setStroke(this.value)">
          <span style="font-size:0.78rem;color:var(--text2)">Personnalis√©e</span>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="ss-label">√âpaisseur & opacit√©</div>
        <div class="prop-row2">
          <span class="pr-label">Contour</span>
          <input type="range" id="swInput" min="0" max="20" value="2" oninput="updateSW(this.value)">
          <span class="pr-val" id="swVal">2</span>
        </div>
        <div class="prop-row2">
          <span class="pr-label">Opacit√©</span>
          <input type="range" id="opInput" min="0.05" max="1" step="0.05" value="1" oninput="updateOp(this.value)">
          <span class="pr-val" id="opVal">100%</span>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="ss-label">Texte</div>
        <select class="font-select" id="fontSel" onchange="applyFont()">
          <option>Arial</option><option>Times New Roman</option>
          <option>Courier New</option><option>Georgia</option>
          <option>Verdana</option><option>Impact</option>
        </select>
        <div class="prop-row2">
          <span class="pr-label">Taille</span>
          <input type="range" id="fsInput" min="8" max="120" value="24" oninput="document.getElementById('fsVal').textContent=this.value;applyFont()">
          <span class="pr-val" id="fsVal">24</span>
        </div>
        <div class="style-btns">
          <button class="st-btn" id="boldBtn" onclick="toggleBold()"><strong>G</strong></button>
          <button class="st-btn" id="italicBtn" onclick="toggleItalic()"><em>I</em></button>
          <button class="st-btn" id="underBtn" onclick="toggleUnder()"><u>S</u></button>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="ss-label">Page</div>
        <div class="page-preset-btns">
          <div class="pp-btn active" onclick="setPage('a4',this)">A4</div>
          <div class="pp-btn" onclick="setPage('a3',this)">A3</div>
          <div class="pp-btn" onclick="setPage('letter',this)">Letter</div>
          <div class="pp-btn" onclick="setPage('16:9',this)">16:9</div>
        </div>
        <div class="import-zone" onclick="document.getElementById('edImport').click()">
          üñºÔ∏è Importer image / PDF
        </div>
        <input type="file" id="edImport" style="display:none" accept="image/*,.pdf" onchange="importDoc(this.files[0])">
      </div>
    </div>

    <!-- CENTER: canvas -->
    <div class="ed-canvas-zone">
      <div class="ed-toolbar">
        <button class="tb-btn" onclick="undoEd()">‚Ü© Annuler</button>
        <button class="tb-btn" onclick="redoEd()">‚Ü™ R√©tablir</button>
        <div class="tb-sep"></div>
        <button class="tb-btn" onclick="dupeSel()">‚ßâ Dupliquer</button>
        <button class="tb-btn" onclick="delSel()">üóë Supprimer</button>
        <button class="tb-btn" onclick="canvas.bringForward(canvas.getActiveObject());canvas.renderAll()">‚Üë Avant</button>
        <button class="tb-btn" onclick="canvas.sendBackwards(canvas.getActiveObject());canvas.renderAll()">‚Üì Arri√®re</button>
        <div class="tb-sep"></div>
        <button class="tb-btn" onclick="clearEd()">‚úï Effacer tout</button>
        <div class="tb-sep"></div>
        <button class="tb-btn tb-export" onclick="exportPDF()">‚¨á Exporter PDF</button>
        <button class="tb-btn" onclick="exportPNG()" style="color:var(--blue)">‚¨á PNG</button>
      </div>
      <div class="canvas-scroll">
        <canvas id="mainCanvas"></canvas>
      </div>
    </div>

    <!-- RIGHT: properties -->
    <div class="ed-props">
      <div class="ss-label">Propri√©t√©s</div>
      <div class="no-sel" id="noSelMsg">
        <span class="no-sel-icon">üëÜ</span>
        Cliquez sur un objet pour voir et modifier ses propri√©t√©s.
      </div>
      <div id="selProps" style="display:none">
        <div class="prop-row2" style="margin-bottom:8px"><span class="pr-label" style="width:auto">X</span><input class="prop-input" type="number" id="pX" oninput="moveSel()"></div>
        <div class="prop-row2" style="margin-bottom:8px"><span class="pr-label" style="width:auto">Y</span><input class="prop-input" type="number" id="pY" oninput="moveSel()"></div>
        <div class="prop-row2" style="margin-bottom:8px"><span class="pr-label" style="width:auto">L</span><input class="prop-input" type="number" id="pW" oninput="sizeSel()"></div>
        <div class="prop-row2" style="margin-bottom:14px"><span class="pr-label" style="width:auto">H</span><input class="prop-input" type="number" id="pH" oninput="sizeSel()"></div>
        <div class="prop-row2">
          <span class="pr-label" style="width:auto">Rotation</span>
          <input type="range" id="pRot" min="-180" max="180" value="0" oninput="document.getElementById('pRotV').textContent=this.value+'¬∞';rotSel()">
          <span class="pr-val" id="pRotV">0¬∞</span>
        </div>
        <div style="border-top:1px solid var(--border);margin:14px 0;padding-top:14px">
          <button class="prop-action" onclick="centerSel('h')">‚Üî Centrer horiz.</button>
          <button class="prop-action" onclick="centerSel('v')">‚Üï Centrer vert.</button>
          <button class="prop-action prop-del" onclick="delSel()">üóë Supprimer</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <span class="modal-icon" id="modalIcon">üéâ</span>
    <div class="modal-title" id="modalTitle">Succ√®s !</div>
    <p class="modal-sub" id="modalSub"></p>
    <div class="modal-btns">
      <button class="btn btn-green" id="modalDl" onclick="downloadAll()">‚¨áÔ∏è T√©l√©charger</button>
      <button class="btn btn-ghost" onclick="closeModal()">Fermer</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CONVERTER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let files = []; // [{id, file, status, blob, thumbUrl}]
let fid = 0;
let mergeOn = true;
let convertedBlobs = []; // for download
let dragSrcIdx = null;

const dropzone = document.getElementById('dropzone');
dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('over'); });
dropzone.addEventListener('dragleave', () => dropzone.classList.remove('over'));
dropzone.addEventListener('drop', e => { e.preventDefault(); dropzone.classList.remove('over'); addFiles(e.dataTransfer.files); });

function addFiles(list) {
  Array.from(list).forEach(f => {
    files.push({ id: fid++, file: f, status: 'ready', blob: null, thumbUrl: null });
  });
  renderCards();
  updateCount();
}

function clearAll() {
  files = [];
  convertedBlobs = [];
  renderCards();
  updateCount();
  document.getElementById('dlBtn').style.display = 'none';
}

function updateCount() {
  document.getElementById('countBadge').textContent = files.length;
}

function toggleMerge() {
  mergeOn = !mergeOn;
  const t = document.getElementById('mergeToggle');
  t.classList.toggle('on', mergeOn);
  document.getElementById('mergeLabel').textContent = mergeOn ? 'Activ√©e' : 'D√©sactiv√©e';
}

// ‚îÄ‚îÄ RENDER CARDS ‚îÄ‚îÄ
function renderCards() {
  const container = document.getElementById('fileCards');
  const empty = document.getElementById('emptyState');
  container.innerHTML = '';
  if (files.length === 0) {
    container.appendChild(Object.assign(document.createElement('div'), {
      className: 'empty-state', id: 'emptyState',
      innerHTML: '<span class="empty-state-icon">üìã</span>Aucun fichier ajout√©.<br>Glissez des fichiers ou cliquez sur la zone ci-dessus.'
    }));
    return;
  }

  files.forEach((f, idx) => {
    const card = document.createElement('div');
    card.className = 'file-card';
    card.draggable = true;
    card.dataset.idx = idx;

    const stClass = { ready:'st-ready', converting:'st-converting', done:'st-done', error:'st-error' }[f.status] || 'st-ready';
    const stLabel = { ready:'Pr√™t', converting:'...', done:'‚úì Converti', error:'‚úó Erreur' }[f.status] || 'Pr√™t';

    const thumbHTML = f.thumbUrl
      ? `<img src="${f.thumbUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:6px">`
      : `<span style="font-size:1.6rem">${fileEmoji(f.file)}</span>`;

    card.innerHTML = `
      <div class="drag-handle" title="Glisser pour r√©ordonner">‚†ø</div>
      <div class="file-card-num">${idx + 1}</div>
      <div class="file-thumb">${thumbHTML}</div>
      <div class="file-card-info">
        <div class="file-card-name" title="${f.file.name}">${f.file.name}</div>
        <div class="file-card-meta">
          <span>${fmtSize(f.file.size)}</span>
          <span>${fileType(f.file)}</span>
        </div>
      </div>
      <span class="file-card-status ${stClass}" id="st-${f.id}">${stLabel}</span>
      <button class="card-remove" onclick="removeFile(${f.id})" title="Supprimer">‚úï</button>
    `;

    // DRAG EVENTS FOR REORDER
    card.addEventListener('dragstart', e => {
      dragSrcIdx = idx;
      setTimeout(() => card.classList.add('dragging'), 0);
      e.dataTransfer.effectAllowed = 'move';
    });
    card.addEventListener('dragend', () => { card.classList.remove('dragging'); });
    card.addEventListener('dragover', e => { e.preventDefault(); card.classList.add('drag-over'); });
    card.addEventListener('dragleave', () => card.classList.remove('drag-over'));
    card.addEventListener('drop', e => {
      e.preventDefault();
      card.classList.remove('drag-over');
      if (dragSrcIdx === null || dragSrcIdx === idx) return;
      const moved = files.splice(dragSrcIdx, 1)[0];
      files.splice(idx, 0, moved);
      dragSrcIdx = null;
      renderCards();
    });

    container.appendChild(card);

    // Generate thumbnail if image
    if (f.file.type.startsWith('image/') && !f.thumbUrl) {
      const reader = new FileReader();
      reader.onload = e => {
        f.thumbUrl = e.target.result;
        const img = card.querySelector('.file-thumb');
        if (img) img.innerHTML = `<img src="${f.thumbUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:6px">`;
      };
      reader.readAsDataURL(f.file);
    }
  });
}

function removeFile(id) {
  files = files.filter(f => f.id !== id);
  renderCards();
  updateCount();
  if (files.length === 0) document.getElementById('dlBtn').style.display = 'none';
}

function fileEmoji(f) {
  if (f.type.startsWith('image/')) return 'üñºÔ∏è';
  if (f.type === 'application/pdf') return 'üìÑ';
  if (f.name.match(/\.docx?$/i)) return 'üìù';
  if (f.type === 'text/plain') return 'üìÉ';
  if (f.type === 'text/html') return 'üåê';
  return 'üìÅ';
}
function fileType(f) {
  const ext = f.file.name.split('.').pop().toUpperCase();
  return ext;
}
function fmtSize(b) {
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b/1024).toFixed(1) + ' Ko';
  return (b/1048576).toFixed(1) + ' Mo';
}

// ‚îÄ‚îÄ CONVERT ‚îÄ‚îÄ
async function runConvert() {
  if (files.length === 0) { toast('Ajoutez d\'abord des fichiers !', 'red'); return; }

  const pw = document.getElementById('progressWrap');
  pw.classList.add('show');
  setProgress(0, 'D√©marrage...');
  convertedBlobs = [];

  const fmt = document.getElementById('optFmt').value;
  const ori = document.getElementById('optOri').value;
  const margin = parseInt(document.getElementById('optMargin').value) || 10;

  for (let i = 0; i < files.length; i++) {
    const f = files[i];
    setStatus(f.id, 'converting');
    setProgress((i / files.length) * 80, `Conversion de ${f.file.name}‚Ä¶`);
    try {
      const blob = await toPDFBlob(f.file, fmt, ori, margin);
      f.blob = blob;
      f.status = 'done';
      convertedBlobs.push({ blob, name: f.file.name.replace(/\.[^.]+$/, '') + '.pdf' });
      setStatus(f.id, 'done');
    } catch (e) {
      f.status = 'error';
      setStatus(f.id, 'error');
      console.error(e);
    }
    renderCards();
  }

  setProgress(90, 'Finalisation‚Ä¶');

  let finalBlobs = convertedBlobs;

  if (mergeOn && convertedBlobs.length > 1) {
    setProgress(95, 'Fusion des PDF‚Ä¶');
    const merged = await mergePDFs(convertedBlobs.map(b => b.blob));
    finalBlobs = [{ blob: merged, name: 'document-fusionne.pdf' }];
    convertedBlobs = finalBlobs;
  }

  setProgress(100, 'Termin√© !');
  setTimeout(() => pw.classList.remove('show'), 600);

  const successCount = files.filter(f => f.status === 'done').length;
  const dlBtn = document.getElementById('dlBtn');
  dlBtn.style.display = 'flex';
  dlBtn.textContent = mergeOn && successCount > 1
    ? `‚¨áÔ∏è T√©l√©charger le PDF fusionn√©`
    : `‚¨áÔ∏è T√©l√©charger ${successCount} PDF`;

  // Show modal
  const isM = mergeOn && successCount > 1;
  document.getElementById('modalIcon').textContent = isM ? 'üéä' : 'üéâ';
  document.getElementById('modalTitle').textContent = isM ? 'PDF fusionn√© pr√™t !' : `${successCount} PDF pr√™t${successCount > 1 ? 's' : ''} !`;
  document.getElementById('modalSub').textContent = isM
    ? `Vos ${successCount} fichiers ont √©t√© fusionn√©s en un seul PDF. Cliquez pour le t√©l√©charger.`
    : `Vos fichiers ont bien √©t√© convertis en PDF. Cliquez pour les t√©l√©charger.`;
  document.getElementById('modal').classList.add('show');
}

function setProgress(pct, label) {
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressStep').textContent = label;
}

function setStatus(id, status) {
  const el = document.getElementById(`st-${id}`);
  if (!el) return;
  const cls = { ready:'st-ready', converting:'st-converting', done:'st-done', error:'st-error' };
  const lbl = { ready:'Pr√™t', converting:'‚è≥ En cours‚Ä¶', done:'‚úì Converti', error:'‚úó Erreur' };
  el.className = 'file-card-status ' + (cls[status] || 'st-ready');
  el.textContent = lbl[status] || 'Pr√™t';
}

async function toPDFBlob(file, fmt, ori, margin) {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation: ori, unit: 'mm', format: fmt });
  const pw = pdf.internal.pageSize.getWidth();
  const ph = pdf.internal.pageSize.getHeight();

  if (file.type.startsWith('image/') || file.name.match(/\.(heic|heif|webp)$/i)) {
    return await imgToPDF(file, pdf, pw, ph, margin);
  } else if (file.type === 'application/pdf') {
    return await pdfPassthrough(file, pdf, pw, ph, margin);
  } else if (file.type === 'text/plain') {
    return await textToPDF(file, pdf, pw, ph, margin);
  } else if (file.type === 'text/html' || file.name.match(/\.html?$/i)) {
    return await htmlToPDF(file, pdf, pw, ph, margin);
  } else {
    return await anyToPDF(file, pdf, pw, ph, margin);
  }
}

function imgToPDF(file, pdf, pw, ph, margin) {
  return new Promise((res, rej) => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        const usW = pw - margin*2, usH = ph - margin*2;
        let iw = usW, ih = img.height/img.width*usW;
        if (ih > usH) { ih = usH; iw = img.width/img.height*usH; }
        const cvs = document.createElement('canvas');
        cvs.width = img.width; cvs.height = img.height;
        cvs.getContext('2d').drawImage(img,0,0);
        const du = cvs.toDataURL('image/jpeg', 0.92);
        pdf.addImage(du,'JPEG',(pw-iw)/2,(ph-ih)/2,iw,ih);
        res(pdf.output('blob'));
      };
      img.onerror = rej;
      img.src = e.target.result;
    };
    reader.onerror = rej;
    reader.readAsDataURL(file);
  });
}

async function pdfPassthrough(file, pdf, pw, ph, margin) {
  const ab = await file.arrayBuffer();
  const pdfDoc = await pdfjsLib.getDocument({ data: ab }).promise;
  for (let i = 1; i <= pdfDoc.numPages; i++) {
    if (i > 1) pdf.addPage();
    const page = await pdfDoc.getPage(i);
    const vp = page.getViewport({ scale: 2 });
    const cvs = document.createElement('canvas');
    cvs.width = vp.width; cvs.height = vp.height;
    await page.render({ canvasContext: cvs.getContext('2d'), viewport: vp }).promise;
    const du = cvs.toDataURL('image/jpeg', 0.9);
    const usW = pw-margin*2, usH = ph-margin*2;
    let iw = usW, ih = cvs.height/cvs.width*usW;
    if (ih > usH) { ih = usH; iw = cvs.width/cvs.height*usH; }
    pdf.addImage(du,'JPEG',(pw-iw)/2,(ph-ih)/2,iw,ih);
  }
  return pdf.output('blob');
}

async function textToPDF(file, pdf, pw, ph, margin) {
  const txt = await file.text();
  pdf.setFontSize(11); pdf.setTextColor(30,30,30);
  const lines = pdf.splitTextToSize(txt, pw - margin*2);
  let y = margin + 10;
  lines.forEach(l => {
    if (y + 6 > ph - margin) { pdf.addPage(); y = margin + 10; }
    pdf.text(l, margin, y); y += 6;
  });
  return pdf.output('blob');
}

async function htmlToPDF(file, pdf, pw, ph, margin) {
  const txt = await file.text();
  const div = document.createElement('div');
  div.innerHTML = txt;
  const plain = div.innerText || div.textContent || '';
  return textToPDF({ text: () => Promise.resolve(plain) }, pdf, pw, ph, margin);
}

async function anyToPDF(file, pdf, pw, ph, margin) {
  let txt = '';
  try {
    const ab = await file.arrayBuffer();
    txt = new TextDecoder('utf-8', { fatal: false }).decode(new Uint8Array(ab));
    txt = txt.replace(/[^\x20-\x7E\xC0-\u024F\n\r\t]/g, ' ').replace(/\s{3,}/g, '\n').trim();
    if (txt.length < 30) txt = `Fichier "${file.name}" converti.\n(Format non textuel)`;
  } catch { txt = file.name; }
  return textToPDF({ text: () => Promise.resolve(txt) }, pdf, pw, ph, margin);
}

// ‚îÄ‚îÄ MERGE ‚îÄ‚îÄ
async function mergePDFs(blobs) {
  const { jsPDF } = window.jspdf;
  const mergedPdf = new jsPDF({ unit: 'px', format: 'a4' });
  let first = true;

  for (const blob of blobs) {
    const ab = await blob.arrayBuffer();
    const pdfDoc = await pdfjsLib.getDocument({ data: ab }).promise;
    for (let i = 1; i <= pdfDoc.numPages; i++) {
      if (!first) mergedPdf.addPage();
      first = false;
      const page = await pdfDoc.getPage(i);
      const vp = page.getViewport({ scale: 2 });
      const cvs = document.createElement('canvas');
      cvs.width = vp.width; cvs.height = vp.height;
      await page.render({ canvasContext: cvs.getContext('2d'), viewport: vp }).promise;
      mergedPdf.internal.pageSize.width = vp.width;
      mergedPdf.internal.pageSize.height = vp.height;
      mergedPdf.addImage(cvs.toDataURL('image/jpeg', 0.9), 'JPEG', 0, 0, vp.width, vp.height);
    }
  }
  return mergedPdf.output('blob');
}

function downloadAll() {
  if (convertedBlobs.length === 0) { toast('Rien √† t√©l√©charger, convertissez d\'abord !', 'red'); return; }
  convertedBlobs.forEach(({ blob, name }) => {
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), { href: url, download: name });
    a.click();
    setTimeout(() => URL.revokeObjectURL(url), 1500);
  });
  closeModal();
}
function closeModal() { document.getElementById('modal').classList.remove('show'); }

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// EDITOR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let canvas, curTool = 'select', fillC = '#4361ee', strokeC = '#1a1d2e', sw = 2;
let isDrawing = false, drawStart = null, tmpShape = null;
let hist = [], hIdx = -1;

function initEditor() {
  canvas = new fabric.Canvas('mainCanvas', {
    backgroundColor: '#ffffff',
    preserveObjectStacking: true,
  });
  setPage('a4', document.querySelector('.pp-btn.active'));

  canvas.on('object:added', saveH);
  canvas.on('object:modified', saveH);
  canvas.on('object:removed', saveH);
  canvas.on('selection:created', showProps);
  canvas.on('selection:updated', showProps);
  canvas.on('selection:cleared', () => {
    document.getElementById('noSelMsg').style.display = 'block';
    document.getElementById('selProps').style.display = 'none';
  });
  canvas.on('mouse:down', mDown);
  canvas.on('mouse:move', mMove);
  canvas.on('mouse:up', mUp);
}

function setPage(p, el) {
  document.querySelectorAll('.pp-btn').forEach(b => b.classList.remove('active'));
  if (el) el.classList.add('active');
  const s = { a4:[794,1123], a3:[1123,1587], letter:[816,1056], '16:9':[1280,720] }[p] || [794,1123];
  canvas.setWidth(s[0]); canvas.setHeight(s[1]); canvas.renderAll();
}

function setTool(t) {
  curTool = t;
  document.querySelectorAll('.t-btn').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById(`tb-${t}`);
  if (btn) btn.classList.add('active');
  canvas.isDrawingMode = (t === 'draw');
  if (t === 'draw') { canvas.freeDrawingBrush.color = strokeC; canvas.freeDrawingBrush.width = sw; }
  canvas.selection = (t === 'select');
  canvas.defaultCursor = t === 'select' ? 'default' : (t === 'text' ? 'text' : 'crosshair');
}

function mDown(opt) {
  if (curTool === 'select' || curTool === 'draw') return;
  if (curTool === 'erase') { if (opt.target) canvas.remove(opt.target); return; }
  if (curTool === 'text') {
    const ptr = canvas.getPointer(opt.e);
    const t = new fabric.IText('Votre texte ici', {
      left: ptr.x, top: ptr.y,
      fontFamily: document.getElementById('fontSel').value,
      fontSize: parseInt(document.getElementById('fsInput').value),
      fill: fillC,
    });
    canvas.add(t);
    canvas.setActiveObject(t);
    t.enterEditing();
    return;
  }
  isDrawing = true;
  drawStart = canvas.getPointer(opt.e);
  const o = { left: drawStart.x, top: drawStart.y, fill: fillC === 'transparent' ? '' : fillC, stroke: strokeC === 'transparent' ? '' : strokeC, strokeWidth: sw, selectable: false, opacity: parseFloat(document.getElementById('opInput').value) };
  if (curTool === 'rect') tmpShape = new fabric.Rect({ ...o, width:0, height:0, rx:3, ry:3 });
  else if (curTool === 'circle') tmpShape = new fabric.Ellipse({ ...o, rx:0, ry:0 });
  else if (curTool === 'line') tmpShape = new fabric.Line([drawStart.x, drawStart.y, drawStart.x, drawStart.y], { stroke: strokeC==='transparent'?'#000':strokeC, strokeWidth:sw, selectable:false });
  if (tmpShape) canvas.add(tmpShape);
}

function mMove(opt) {
  if (!isDrawing || !tmpShape) return;
  const ptr = canvas.getPointer(opt.e);
  const dx = ptr.x - drawStart.x, dy = ptr.y - drawStart.y;
  if (curTool === 'rect') {
    tmpShape.set({ left: dx<0?ptr.x:drawStart.x, top: dy<0?ptr.y:drawStart.y, width:Math.abs(dx), height:Math.abs(dy) });
  } else if (curTool === 'circle') {
    tmpShape.set({ left: dx>0?drawStart.x:ptr.x, top: dy>0?drawStart.y:ptr.y, rx:Math.abs(dx)/2, ry:Math.abs(dy)/2 });
  } else if (curTool === 'line') {
    tmpShape.set({ x2:ptr.x, y2:ptr.y });
  }
  canvas.renderAll();
}

function mUp() {
  if (!isDrawing) return;
  isDrawing = false;
  if (tmpShape) { tmpShape.set({selectable:true}); canvas.setActiveObject(tmpShape); tmpShape=null; setTool('select'); }
}

function addArrow() {
  const cx = canvas.width/2, cy = canvas.height/2;
  const g = new fabric.Group([
    new fabric.Line([cx-80,cy,cx+70,cy], { stroke:strokeC==='transparent'?var_blue:strokeC, strokeWidth:sw||3 }),
    new fabric.Triangle({ width:16, height:14, fill:strokeC==='transparent'?'#4361ee':strokeC, left:cx+62, top:cy-7, angle:90 }),
  ]);
  canvas.add(g); canvas.setActiveObject(g); canvas.renderAll();
}
const var_blue = '#4361ee';

function addSym(s) {
  const t = new fabric.Text(s, { left:canvas.width/2-20, top:canvas.height/2-20, fontSize:42, fill:fillC==='transparent'?'#4361ee':fillC });
  canvas.add(t); canvas.setActiveObject(t); canvas.renderAll();
}

function pickFill(el) {
  document.querySelectorAll('#fillSwatches .swatch').forEach(s => s.classList.remove('sel'));
  el.classList.add('sel');
  fillC = el.dataset.c;
  if (fillC !== 'transparent') document.getElementById('fillPicker').value = fillC;
  applyProp('fill', fillC === 'transparent' ? '' : fillC);
}
function setFill(v) { fillC = v; applyProp('fill', v); }
function pickStroke(el) {
  document.querySelectorAll('#strokeSwatches .swatch').forEach(s => s.classList.remove('sel'));
  el.classList.add('sel');
  strokeC = el.dataset.c;
  if (strokeC !== 'transparent') document.getElementById('strokePicker').value = strokeC;
  applyProp('stroke', strokeC==='transparent'?'':strokeC);
  canvas.freeDrawingBrush.color = strokeC;
}
function setStroke(v) { strokeC = v; applyProp('stroke', v); canvas.freeDrawingBrush.color = v; }
function updateSW(v) {
  sw = parseInt(v); document.getElementById('swVal').textContent = v;
  applyProp('strokeWidth', sw); canvas.freeDrawingBrush.width = sw;
}
function updateOp(v) {
  document.getElementById('opVal').textContent = Math.round(v*100)+'%';
  applyProp('opacity', parseFloat(v));
}
function applyProp(k, v) {
  const o = canvas.getActiveObject(); if (!o) return;
  if (o.type === 'activeSelection') o.getObjects().forEach(i => i.set(k,v));
  else o.set(k,v);
  canvas.renderAll();
}
function applyFont() {
  const o = canvas.getActiveObject();
  if (!o || (o.type !== 'i-text' && o.type !== 'text')) return;
  o.set({ fontFamily: document.getElementById('fontSel').value, fontSize: parseInt(document.getElementById('fsInput').value) });
  canvas.renderAll();
}
function toggleBold() { const o=canvas.getActiveObject(); if(!o)return; o.set('fontWeight',o.fontWeight==='bold'?'normal':'bold'); document.getElementById('boldBtn').classList.toggle('on',o.fontWeight==='bold'); canvas.renderAll(); }
function toggleItalic() { const o=canvas.getActiveObject(); if(!o)return; o.set('fontStyle',o.fontStyle==='italic'?'normal':'italic'); document.getElementById('italicBtn').classList.toggle('on',o.fontStyle==='italic'); canvas.renderAll(); }
function toggleUnder() { const o=canvas.getActiveObject(); if(!o)return; o.set('underline',!o.underline); document.getElementById('underBtn').classList.toggle('on',o.underline); canvas.renderAll(); }

function dupeSel() {
  const o=canvas.getActiveObject(); if(!o)return;
  o.clone(c => { c.set({left:o.left+20,top:o.top+20}); canvas.add(c); canvas.setActiveObject(c); canvas.renderAll(); });
}
function delSel() {
  const o=canvas.getActiveObject(); if(!o)return;
  if(o.type==='activeSelection') { o.getObjects().forEach(i=>canvas.remove(i)); canvas.discardActiveObject(); }
  else canvas.remove(o);
  canvas.renderAll();
}
function clearEd() { if(!confirm('Effacer tout le contenu ?'))return; canvas.clear(); canvas.backgroundColor='#ffffff'; canvas.renderAll(); }
function centerSel(axis) {
  const o=canvas.getActiveObject(); if(!o)return;
  if(axis==='h') o.set('left',(canvas.width-o.getScaledWidth())/2);
  if(axis==='v') o.set('top',(canvas.height-o.getScaledHeight())/2);
  o.setCoords(); canvas.renderAll();
}

function showProps() {
  const o=canvas.getActiveObject(); if(!o)return;
  document.getElementById('noSelMsg').style.display='none';
  document.getElementById('selProps').style.display='block';
  document.getElementById('pX').value=Math.round(o.left);
  document.getElementById('pY').value=Math.round(o.top);
  document.getElementById('pW').value=Math.round(o.getScaledWidth());
  document.getElementById('pH').value=Math.round(o.getScaledHeight());
  document.getElementById('pRot').value=Math.round(o.angle);
  document.getElementById('pRotV').textContent=Math.round(o.angle)+'¬∞';
}
function moveSel() {
  const o=canvas.getActiveObject(); if(!o)return;
  o.set({left:parseInt(document.getElementById('pX').value),top:parseInt(document.getElementById('pY').value)});
  o.setCoords(); canvas.renderAll();
}
function sizeSel() {
  const o=canvas.getActiveObject(); if(!o)return;
  o.set({scaleX:parseInt(document.getElementById('pW').value)/o.width, scaleY:parseInt(document.getElementById('pH').value)/o.height});
  o.setCoords(); canvas.renderAll();
}
function rotSel() {
  const o=canvas.getActiveObject(); if(!o)return;
  o.set('angle',parseInt(document.getElementById('pRot').value)); o.setCoords(); canvas.renderAll();
}

function saveH() {
  const j=JSON.stringify(canvas.toJSON());
  hist=hist.slice(0,hIdx+1); hist.push(j); hIdx=hist.length-1;
}
function undoEd() { if(hIdx<=0)return; hIdx--; canvas.loadFromJSON(hist[hIdx],()=>canvas.renderAll()); }
function redoEd() { if(hIdx>=hist.length-1)return; hIdx++; canvas.loadFromJSON(hist[hIdx],()=>canvas.renderAll()); }

async function importDoc(file) {
  if (!file) return;
  if (file.type.startsWith('image/')) {
    const r = new FileReader();
    r.onload = e => {
      fabric.Image.fromURL(e.target.result, img => {
        const mW = canvas.width*0.9;
        if (img.width > mW) { const s=mW/img.width; img.scaleX=s; img.scaleY=s; }
        img.set({left:10,top:10}); canvas.add(img); canvas.setActiveObject(img); canvas.renderAll();
      });
    };
    r.readAsDataURL(file);
  } else if (file.type === 'application/pdf') {
    const ab = await file.arrayBuffer();
    const pd = await pdfjsLib.getDocument({data:ab}).promise;
    const page = await pd.getPage(1);
    const vp = page.getViewport({scale:1.5});
    const cvs = document.createElement('canvas');
    cvs.width=vp.width; cvs.height=vp.height;
    await page.render({canvasContext:cvs.getContext('2d'),viewport:vp}).promise;
    fabric.Image.fromURL(cvs.toDataURL(), img => {
      const mW = canvas.width*0.95;
      if (img.width > mW) { const s=mW/img.width; img.scaleX=s; img.scaleY=s; }
      img.set({left:5,top:5}); canvas.add(img); canvas.sendToBack(img); canvas.renderAll();
    });
    toast('PDF import√© (page 1) ‚Äî annotez maintenant !', 'green');
  }
}

function exportPDF() {
  const { jsPDF } = window.jspdf;
  const w=canvas.width, h=canvas.height;
  const du=canvas.toDataURL({format:'jpeg',quality:0.95});
  const pdf=new jsPDF({orientation:w>h?'landscape':'portrait',unit:'px',format:[w,h]});
  pdf.addImage(du,'JPEG',0,0,w,h);
  pdf.save('document-edite.pdf');
  toast('PDF export√© avec succ√®s ! üéâ', 'green');
}
function exportPNG() {
  const a=Object.assign(document.createElement('a'),{href:canvas.toDataURL({format:'png',multiplier:2}),download:'document.png'});
  a.click();
  toast('PNG export√© !', 'green');
}

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
function goPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById(`page-${id}`).classList.add('active');
  const tabs = document.querySelectorAll('.nav-tab');
  if (id === 'convert') tabs[0].classList.add('active');
  else tabs[1].classList.add('active');
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
let toastTimer;
function toast(msg, type='') {
  const old=document.querySelector('.toast'); if(old)old.remove();
  clearTimeout(toastTimer);
  const el=Object.assign(document.createElement('div'),{className:`toast ${type}`,innerHTML:`<span>${msg}</span>`});
  document.body.appendChild(el);
  toastTimer=setTimeout(()=>el.remove(),3200);
}

window.addEventListener('load', initEditor);
</script>
</body>
</html>
